<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>KKI Housing Monitor v3 â€“ Mayiladuthurai</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+Tamil:wght@400;600;700&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Mono:wght@400;500&display=swap');
:root{--navy:#0d1b3e;--navy-mid:#152649;--navy-light:#1e3560;--gold:#d4a017;--gold-light:#f0c040;--saffron:#e8852a;--teal:#1a7a6e;--teal-light:#21a08f;--red:#c0392b;--red-light:#e74c3c;--green:#1a7a4a;--green-light:#22a86a;--purple:#5b3fa0;--orange:#d35400;--blue:#2563eb;--r:12px;--rsm:8px}
[data-theme="light"]{--bg:#f0f4fa;--bgc:#fff;--bgh:#e8f0fb;--bgi:#fff;--bgt:#f7faff;--borth:#0d1b3e;--bor:#d8e4f0;--tx:#1a2a4a;--txm:#5a6a8a;--shd:0 2px 12px rgba(13,27,62,.1);--shdl:0 8px 32px rgba(13,27,62,.18);--sv:#0d1b3e;--nb:#152649;--scr:#cdd5e0;--tag:#e2e8f0;--tagc:#334155;--gp:#fdf3d0}
[data-theme="dark"]{--bg:#0a0d14;--bgc:#131825;--bgh:#1c2338;--bgi:#1a2035;--bgt:#141928;--borth:#0d1b3e;--bor:#1e2d4a;--tx:#d8e4f8;--txm:#7a8aaa;--shd:0 2px 16px rgba(0,0,0,.5);--shdl:0 8px 40px rgba(0,0,0,.6);--sv:#e2ebff;--nb:#0a0d14;--scr:#1e2d4a;--tag:#1e2d4a;--tagc:#a0b0d0;--gp:#1a1a06}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;font-size:14px;line-height:1.5;transition:background .3s,color .3s;padding-bottom:env(safe-area-inset-bottom)}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-thumb{background:var(--scr);border-radius:3px}

/* â”€â”€ HEADER â”€â”€ */
.app-header{background:linear-gradient(135deg,var(--navy) 0%,var(--navy-light) 60%,#1f4080 100%);color:#fff;box-shadow:0 4px 20px rgba(0,0,0,.4);position:sticky;top:0;z-index:200}
.hdr-top{display:flex;align-items:center;gap:12px;padding:11px 18px;border-bottom:1px solid rgba(255,255,255,.1)}
.hdr-emblem{width:42px;height:42px;background:var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;box-shadow:0 0 0 3px rgba(212,160,23,.3)}
.hdr-titles{flex:1;min-width:0}
.hdr-titles h1{font-size:14px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hdr-tamil{font-family:'Noto Serif Tamil',serif;font-size:11px;color:var(--gold-light);margin-top:1px}
.hdr-sub{font-size:9px;color:rgba(255,255,255,.5);letter-spacing:.8px;text-transform:uppercase;display:none}
.hdr-ctrl{display:flex;align-items:center;gap:8px;flex-shrink:0}
.badge{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:3px 9px;font-size:10px;color:rgba(255,255,255,.8);font-weight:500;white-space:nowrap}
.badge.gold{background:rgba(212,160,23,.25);border-color:var(--gold);color:var(--gold-light)}
.theme-btn{width:38px;height:20px;background:rgba(255,255,255,.15);border-radius:10px;border:1px solid rgba(255,255,255,.3);cursor:pointer;position:relative;flex-shrink:0}
.theme-btn::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.3)}
[data-theme="dark"] .theme-btn::after{transform:translateX(18px);background:var(--gold-light)}

/* â”€â”€ DESKTOP NAV â”€â”€ */
.desk-nav{display:flex;overflow-x:auto;scrollbar-width:none;background:var(--nb);padding:0 14px}
.desk-nav::-webkit-scrollbar{display:none}
.nav-tab{padding:9px 12px;font-size:11.5px;font-weight:500;color:rgba(255,255,255,.5);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;user-select:none;display:flex;align-items:center;gap:4px;min-height:40px}
.nav-tab:hover{color:rgba(255,255,255,.85);background:rgba(255,255,255,.05)}
.nav-tab.active{color:var(--gold-light);border-bottom-color:var(--gold);font-weight:600}

/* â”€â”€ MOBILE NAV â”€â”€ */
.mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bgc);border-top:1px solid var(--bor);z-index:200;padding:3px 0 max(3px,env(safe-area-inset-bottom));box-shadow:0 -4px 20px rgba(0,0,0,.12)}
.mob-nav-row{display:flex;justify-content:space-around}
.mob-tab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:5px 2px;cursor:pointer;border:none;background:none;color:var(--txm);transition:color .2s;min-height:50px;-webkit-tap-highlight-color:transparent}
.mob-tab.active{color:var(--navy)}
[data-theme="dark"] .mob-tab.active{color:var(--gold-light)}
.mob-icon{font-size:19px;line-height:1}
.mob-lbl{font-size:9px;font-weight:600;margin-top:2px;letter-spacing:.3px}

/* â”€â”€ MORE DRAWER â”€â”€ */
.drawer-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:298}
.drawer-overlay.open{display:block}
.more-drawer{position:fixed;bottom:0;left:0;right:0;background:var(--bgc);border-top-left-radius:18px;border-top-right-radius:18px;box-shadow:0 -8px 40px rgba(0,0,0,.25);z-index:299;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);padding:14px 0 max(18px,env(safe-area-inset-bottom))}
.more-drawer.open{transform:translateY(0)}
.drawer-handle{width:36px;height:4px;background:var(--bor);border-radius:2px;margin:0 auto 14px}
.drawer-grid{display:grid;grid-template-columns:1fr 1fr;gap:0}
.drawer-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:16px 8px;cursor:pointer;border:none;background:none;color:var(--tx);transition:background .15s}
.drawer-item:active{background:var(--bgh)}
.drawer-item-icon{font-size:24px}
.drawer-item-lbl{font-size:11px;font-weight:600;color:var(--txm)}

/* â”€â”€ LAYOUT â”€â”€ */
.main-content{max-width:1400px;margin:0 auto;padding:18px 15px 90px}
.page{display:none}.page.active{display:block}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}

/* â”€â”€ COMPONENTS â”€â”€ */
.sec{font-size:15px;font-weight:700;color:var(--tx);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.sec::before{content:'';width:4px;height:20px;background:var(--gold);border-radius:2px;display:block;flex-shrink:0}
.card{background:var(--bgc);border-radius:var(--r);box-shadow:var(--shd);border:1px solid var(--bor);padding:18px;transition:background .3s,border-color .3s}
.card-hd{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--txm);margin-bottom:12px}

/* â”€â”€ STAT CARDS â”€â”€ */
.sgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:18px}
.sc{background:var(--bgc);border-radius:var(--r);padding:15px;box-shadow:var(--shd);border:1px solid var(--bor);position:relative;overflow:hidden;transition:background .3s,border-color .3s,transform .15s}
.sc:active{transform:scale(.98)}
.sc::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.sc.cn::before{background:var(--navy)}.sc.cg::before{background:var(--green-light)}.sc.cs::before{background:var(--saffron)}.sc.ct::before{background:var(--teal-light)}.sc.cr::before{background:var(--red)}.sc.cp::before{background:var(--purple)}.sc.co::before{background:var(--orange)}.sc.cb::before{background:var(--blue)}
.si{font-size:20px;margin-bottom:5px}
.sv{font-size:26px;font-weight:700;color:var(--sv);line-height:1;font-family:'DM Mono',monospace}
.sl{font-size:11px;color:var(--txm);margin-top:3px;font-weight:500}
.sp{font-size:11.5px;font-weight:600;margin-top:4px}
.sp.good{color:var(--green-light)}.sp.warn{color:var(--saffron)}.sp.bad{color:var(--red-light)}

/* â”€â”€ PROGRESS â”€â”€ */
.pb{height:6px;background:var(--bor);border-radius:4px;overflow:hidden;margin-top:7px}
.pf{height:100%;border-radius:4px;transition:width .7s cubic-bezier(.4,0,.2,1)}
.pg{background:linear-gradient(90deg,#1a7a4a,#22a86a)}.po{background:linear-gradient(90deg,#e8852a,#f0a050)}.pt{background:linear-gradient(90deg,#1a7a6e,#21a08f)}.pr{background:linear-gradient(90deg,#c0392b,#e74c3c)}.pn{background:linear-gradient(90deg,#0d1b3e,#1e3560)}.pp{background:linear-gradient(90deg,#5b3fa0,#7c5ac0)}.pb2{background:linear-gradient(90deg,#2563eb,#60a5fa)}.pgl{background:linear-gradient(90deg,#d4a017,#f0c040)}

/* â”€â”€ TABLE â”€â”€ */
.tw{overflow:auto;max-height:420px;border-radius:var(--rsm);border:1px solid var(--bor);-webkit-overflow-scrolling:touch}
.dt{width:100%;border-collapse:collapse;font-size:12.5px;min-width:500px}
.dt th{background:var(--borth);color:#fff;padding:9px 11px;text-align:left;font-weight:600;font-size:11px;letter-spacing:.4px;position:sticky;top:0;z-index:1;white-space:nowrap}
.dt td{padding:8px 11px;border-bottom:1px solid var(--bor);color:var(--tx);vertical-align:middle}
.dt tr:hover td{background:var(--bgh)}
.dt tr:nth-child(even) td{background:var(--bgt)}
.dt tr:nth-child(even):hover td{background:var(--bgh)}

/* â”€â”€ BADGES â”€â”€ */
.sbadge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:600;white-space:nowrap}
.s-c{background:rgba(34,168,106,.15);color:#22a86a;border:1px solid rgba(34,168,106,.3)}
.s-p{background:rgba(37,99,235,.15);color:#60a5fa;border:1px solid rgba(37,99,235,.3)}
.s-w{background:rgba(124,58,237,.15);color:#a78bfa;border:1px solid rgba(124,58,237,.3)}
.s-pl{background:rgba(220,38,38,.15);color:#f87171;border:1px solid rgba(220,38,38,.3)}
.s-r{background:rgba(217,119,6,.15);color:#f59e0b;border:1px solid rgba(217,119,6,.3)}
.s-o{background:var(--tag);color:var(--tagc);border:1px solid var(--bor)}

/* â”€â”€ RISK â”€â”€ */
.risk-low{background:rgba(34,168,106,.15);color:#22a86a;border:1px solid rgba(34,168,106,.3);display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
.risk-med{background:rgba(245,158,11,.15);color:#f59e0b;border:1px solid rgba(245,158,11,.3);display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}
.risk-high{background:rgba(220,38,38,.15);color:#f87171;border:1px solid rgba(220,38,38,.3);display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700}

/* â”€â”€ FORMS â”€â”€ */
.fg{margin-bottom:12px}
.fl{font-size:12px;font-weight:600;color:var(--tx);margin-bottom:4px;display:block}
.fi,.fsel,.fta{width:100%;padding:9px 11px;border:1.5px solid var(--bor);border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:14px;color:var(--tx);background:var(--bgi);transition:border-color .2s,background .3s;outline:none;-webkit-appearance:none;appearance:none}
.fi:focus,.fsel:focus,.fta:focus{border-color:#3b82f6}
.fta{min-height:80px;resize:vertical}
.fsel{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238892a4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:9px 16px;border-radius:var(--rsm);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .18s;white-space:nowrap;min-height:42px;-webkit-tap-highlight-color:transparent}
.btn-p{background:var(--navy);color:#fff}.btn-p:hover{background:var(--navy-light)}
.btn-g{background:var(--gold);color:var(--navy)}.btn-g:hover{background:var(--gold-light)}
.btn-d{background:var(--red);color:#fff}.btn-d:hover{background:#a93226}
.btn-o{background:transparent;color:var(--tx);border:1.5px solid var(--bor)}.btn-o:hover{background:var(--bgh)}
.btn-t{background:var(--teal);color:#fff}.btn-t:hover{background:var(--teal-light)}
.btn-sm{padding:5px 10px;font-size:11px;min-height:32px}
.btn-full{width:100%}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:var(--green-light)}

/* â”€â”€ ALERTS â”€â”€ */
.alert{padding:11px 14px;border-radius:var(--rsm);margin-bottom:14px;font-size:13px;display:flex;align-items:flex-start;gap:9px;line-height:1.5}
.al-i{background:rgba(59,130,246,.1);border-left:4px solid #3b82f6;color:#60a5fa}
.al-s{background:rgba(16,185,129,.1);border-left:4px solid #10b981;color:#34d399}
.al-w{background:rgba(245,158,11,.15);border-left:4px solid #f59e0b;color:#fbbf24}
.al-d{background:rgba(239,68,68,.1);border-left:4px solid #ef4444;color:#f87171}
[data-theme="light"] .al-i{color:#1e40af;background:#dbeafe}[data-theme="light"] .al-s{color:#065f46;background:#d1fae5}[data-theme="light"] .al-w{color:#92400e;background:#fef3c7}[data-theme="light"] .al-d{color:#991b1b;background:#fee2e2}

/* â”€â”€ SEARCH â”€â”€ */
.srch{display:flex;align-items:center;background:var(--bgi);border:1.5px solid var(--bor);border-radius:var(--rsm);padding:0 11px;gap:7px;margin-bottom:12px;min-height:42px}
.srch input{flex:1;border:none;outline:none;padding:9px 0;font-family:'DM Sans',sans-serif;font-size:14px;color:var(--tx);background:transparent}
.srch input::placeholder{color:var(--txm)}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:48px 20px;color:var(--txm)}
.empty .ei{font-size:42px;margin-bottom:10px}
.empty h3{font-size:16px;color:var(--tx);margin-bottom:5px}
.empty p{font-size:13px;max-width:300px;margin:0 auto}

/* â”€â”€ BAR CHART â”€â”€ */
.bc{display:flex;flex-direction:column;gap:9px}
.br{display:flex;align-items:center;gap:7px}
.bl{font-size:11.5px;color:var(--tx);width:130px;flex-shrink:0;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bl.s{width:100px}
.bt{flex:1;height:20px;background:var(--bor);border-radius:4px;overflow:hidden;min-width:40px}
.bf{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:5px;font-size:9px;font-weight:600;color:rgba(255,255,255,.9);transition:width .8s cubic-bezier(.4,0,.2,1)}
.bv{font-size:11px;color:var(--txm);font-family:'DM Mono',monospace;width:45px;text-align:right;flex-shrink:0}

/* â”€â”€ STACKED BAR â”€â”€ */
.stkbar{display:flex;height:24px;border-radius:5px;overflow:hidden;width:100%}
.stkseg{display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:600;color:rgba(255,255,255,.9);overflow:hidden;transition:width .6s}

/* â”€â”€ LEGEND â”€â”€ */
.legend{display:flex;flex-wrap:wrap;gap:9px;margin-top:10px}
.li{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--tx)}
.ld{width:9px;height:9px;border-radius:2px;flex-shrink:0}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:500;align-items:center;justify-content:center;padding:16px}
.modal-overlay.open{display:flex}
.modal{background:var(--bgc);border-radius:var(--r);box-shadow:var(--shdl);width:100%;max-width:560px;max-height:90vh;overflow:auto;position:relative}
.modal-hd{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--bor);font-size:15px;font-weight:700;color:var(--tx);position:sticky;top:0;background:var(--bgc);z-index:1}
.modal-body{padding:20px}
.modal-close{background:none;border:none;cursor:pointer;font-size:20px;color:var(--txm);line-height:1;padding:4px}

/* â”€â”€ CAMERA MODAL â”€â”€ */
.cam-wrap{position:relative;background:#000;border-radius:var(--rsm);overflow:hidden;aspect-ratio:4/3}
#cam-video{width:100%;height:100%;object-fit:cover;display:block}
#cam-canvas{width:100%;height:100%;object-fit:cover;display:none}
.cam-ts{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);color:#fff;font-size:12px;font-family:'DM Mono',monospace;padding:8px 12px;letter-spacing:.5px}
.cam-ctrl{display:flex;gap:10px;margin-top:12px;justify-content:center}
.cam-preview{width:100%;border-radius:var(--rsm);display:none;margin-top:10px}

/* â”€â”€ PHOTO THUMB â”€â”€ */
.photo-thumb{width:72px;height:72px;object-fit:cover;border-radius:var(--rsm);border:2px solid var(--bor);cursor:pointer}
.photo-thumb:hover{border-color:var(--gold)}
.photo-grid{display:flex;flex-wrap:wrap;gap:8px}
.photo-slot{width:72px;height:72px;border:2px dashed var(--bor);border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;color:var(--txm);transition:border-color .2s;flex-direction:column;gap:2px;font-size:18px}
.photo-slot:hover{border-color:var(--gold);color:var(--gold)}
.photo-slot span{font-size:9px;color:var(--txm);font-weight:600;text-align:center}

/* â”€â”€ STAFF CARDS â”€â”€ */
.staff-card{background:var(--bgc);border:1px solid var(--bor);border-radius:var(--r);padding:16px;transition:border-color .2s,box-shadow .2s;position:relative}
.staff-card:hover{border-color:var(--gold);box-shadow:0 4px 20px rgba(212,160,23,.15)}
.staff-avatar{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--navy-light));color:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:700;flex-shrink:0}
.desig-badge{display:inline-block;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;margin-top:4px}
.dJE{background:rgba(37,99,235,.15);color:#60a5fa}.dAE{background:rgba(34,168,106,.15);color:#22a86a}.dOV{background:rgba(212,160,23,.2);color:var(--gold)}.dSI{background:rgba(124,58,237,.15);color:#a78bfa}.dEE{background:rgba(220,38,38,.15);color:#f87171}

/* â”€â”€ VISIT CHECKLIST â”€â”€ */
.chk-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--bor)}
.chk-item:last-child{border-bottom:none}
.chk-box{width:20px;height:20px;border:2px solid var(--bor);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.chk-box.checked{background:var(--green-light);border-color:var(--green-light);color:#fff}
.chk-lbl{font-size:13px;color:var(--tx)}
.chk-num{font-size:11px;color:var(--txm);width:20px;flex-shrink:0;font-weight:600}

/* â”€â”€ MATERIAL RECORD â”€â”€ */
.mat-row{border:1px solid var(--bor);border-radius:var(--rsm);padding:12px;background:var(--bgc);margin-bottom:8px;transition:background .3s}
.mat-photo{width:56px;height:56px;object-fit:cover;border-radius:var(--rsm);border:2px solid var(--bor);cursor:pointer}

/* â”€â”€ UPLOAD ZONE â”€â”€ */
.uz{border:2px dashed var(--gold);border-radius:var(--r);background:var(--gp);padding:32px 16px;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.uz:hover,.uz.drag{background:rgba(212,160,23,.12);border-color:var(--saffron);transform:scale(1.01)}
.uz input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.fmt-chips{display:flex;flex-wrap:wrap;justify-content:center;gap:7px;margin-top:12px}
.fchip{padding:3px 9px;border-radius:20px;font-size:10.5px;font-weight:600;border:1px solid}
.fxls{background:rgba(34,139,34,.1);color:#22a86a;border-color:rgba(34,139,34,.3)}
.fxlsx{background:rgba(16,185,129,.1);color:#10b981;border-color:rgba(16,185,129,.3)}
.fcsv{background:rgba(245,158,11,.1);color:#f59e0b;border-color:rgba(245,158,11,.3)}
.fhtml{background:rgba(59,130,246,.1);color:#60a5fa;border-color:rgba(59,130,246,.3)}

/* â”€â”€ SNAP ITEM â”€â”€ */
.snap-item{border:1px solid var(--bor);border-radius:var(--rsm);padding:12px;background:var(--bgc);margin-bottom:9px;display:flex;align-items:center;gap:11px}
.snap-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.snap-info{flex:1;min-width:0}
.snap-date{font-size:12px;font-weight:600;color:var(--tx)}
.snap-meta{font-size:11px;color:var(--txm);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* â”€â”€ LOG â”€â”€ */
.log-e{padding:12px;border-radius:var(--rsm);border:1px solid var(--bor);background:var(--bgc);margin-bottom:9px;position:relative;transition:background .3s,border-color .3s}
.log-del{position:absolute;top:9px;right:9px;background:none;border:none;color:var(--red-light);cursor:pointer;font-size:15px;opacity:.5;padding:3px}
.log-del:hover{opacity:1}

/* â”€â”€ CERT â”€â”€ */
.cert{background:#fff;color:#000;border:3px double #0d1b3e;border-radius:var(--r);padding:30px;max-width:700px;margin:0 auto;font-family:'DM Sans',sans-serif}
.cert-title{text-align:center;font-size:20px;font-weight:700;color:#0d1b3e;margin-bottom:4px}
.cert-sub{text-align:center;font-size:13px;color:#5a6a8a;margin-bottom:20px}
.cert-seal{text-align:center;font-size:40px;margin-bottom:14px}
.cert-field{border-bottom:1px solid #ccc;margin-bottom:12px;padding-bottom:4px}
.cert-field label{font-size:11px;color:#5a6a8a;text-transform:uppercase;letter-spacing:.8px;display:block}
.cert-field span{font-size:14px;font-weight:600;color:#1a2a4a}
@media print{body *{display:none!important}.cert,.cert *{display:revert!important}}

/* â”€â”€ TREND SVG â”€â”€ */
.trend-svg{width:100%;height:160px;overflow:visible}

/* â”€â”€ AUDIT ROW â”€â”€ */
.aud-row{padding:10px 12px;border-bottom:1px solid var(--bor);display:flex;gap:12px;align-items:flex-start}
.aud-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.aud-ts{font-size:10px;font-family:'DM Mono',monospace;color:var(--txm)}
.aud-action{font-size:12px;color:var(--tx)}

/* â”€â”€ PRINT REPORT â”€â”€ */
@media print{.app-header,.mob-nav,.more-drawer,.btn,nav,footer{display:none!important}.main-content{padding:0}}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:900px){.g3{grid-template-columns:1fr 1fr}.g4{grid-template-columns:1fr 1fr}}
@media(max-width:768px){
  body{padding-bottom:calc(58px + env(safe-area-inset-bottom))}
  .desk-nav{display:none}.mob-nav{display:block}
  .hdr-sub{display:block}.g2,.g3,.g4{grid-template-columns:1fr}
  .sgrid{grid-template-columns:repeat(2,1fr);gap:9px}
  .sv{font-size:22px}.main-content{padding:13px 11px 85px}
  .card{padding:13px}.hdr-top{padding:9px 12px;gap:9px}
  .hdr-titles h1{font-size:12px}.badge{display:none}
  #hdr-total{display:flex!important;font-size:9px;padding:2px 7px}
  .tw{max-height:350px}.bl{width:80px;font-size:10.5px}.bl.s{width:70px}
  .sec{font-size:13px}
}
@media(max-width:480px){.sgrid{grid-template-columns:repeat(2,1fr)}.sv{font-size:20px}.hdr-emblem{width:34px;height:34px;font-size:17px}.hdr-tamil{display:none}}
</style>
</head>
<body>

<header class="app-header">
  <div class="hdr-top">
    <div class="hdr-emblem">ğŸ </div>
    <div class="hdr-titles">
      <h1>Kalaignarin Kanavu Illam â€“ Housing Monitor</h1>
      <div class="hdr-tamil">à®•à®²à¯ˆà®à®°à®¿à®©à¯ à®•à®©à®µà¯ à®‡à®²à¯à®²à®®à¯</div>
      <div class="hdr-sub">Mayiladuthurai District Â· TN Govt Â· v3.0</div>
    </div>
    <div class="hdr-ctrl">
      <span class="badge gold" id="hdr-total">â³ Load Data</span>
      <span class="badge" id="hdr-snaps">ğŸ“ 0</span>
      <div class="theme-btn" id="theme-btn" title="Toggle Day/Night"></div>
      <span id="theme-lbl" style="font-size:13px">â˜€ï¸</span>
    </div>
  </div>
  <nav class="desk-nav" id="desk-nav">
    <div class="nav-tab active" onclick="P('dashboard')">ğŸ“Š Dashboard</div>
    <div class="nav-tab" onclick="P('upload')">ğŸ“¤ Upload</div>
    <div class="nav-tab" onclick="P('staff')">ğŸ‘· Staff</div>
    <div class="nav-tab" onclick="P('materials')">ğŸ§± Materials</div>
    <div class="nav-tab" onclick="P('analytics')">ğŸ“ˆ Analytics</div>
    <div class="nav-tab" onclick="P('visits')">ğŸ” Site Visits</div>
    <div class="nav-tab" onclick="P('blocks')">ğŸ˜ Blocks</div>
    <div class="nav-tab" onclick="P('villages')">ğŸŒ¾ Villages</div>
    <div class="nav-tab" onclick="P('houses')">ğŸ  Houses</div>
    <div class="nav-tab" onclick="P('stagnant')">âš ï¸ Stagnant</div>
    <div class="nav-tab" onclick="P('pending')">ğŸ”´ Pending</div>
    <div class="nav-tab" onclick="P('reports')">ğŸ“‹ Reports</div>
    <div class="nav-tab" onclick="P('log')">ğŸ“ Log</div>
    <div class="nav-tab" onclick="P('audit')">ğŸ”’ Audit</div>
  </nav>
</header>

<nav class="mob-nav">
  <div class="mob-nav-row">
    <button class="mob-tab active" onclick="P('dashboard')" data-pg="dashboard"><div class="mob-icon">ğŸ“Š</div><div class="mob-lbl">Dashboard</div></button>
    <button class="mob-tab" onclick="P('upload')" data-pg="upload"><div class="mob-icon">ğŸ“¤</div><div class="mob-lbl">Upload</div></button>
    <button class="mob-tab" onclick="P('staff')" data-pg="staff"><div class="mob-icon">ğŸ‘·</div><div class="mob-lbl">Staff</div></button>
    <button class="mob-tab" onclick="P('materials')" data-pg="materials"><div class="mob-icon">ğŸ§±</div><div class="mob-lbl">Materials</div></button>
    <button class="mob-tab" onclick="openDrawer()"><div class="mob-icon">â‹¯</div><div class="mob-lbl">More</div></button>
  </div>
</nav>

<div class="drawer-overlay" id="dov" onclick="closeDrawer()"></div>
<div class="more-drawer" id="mdrawer">
  <div class="drawer-handle"></div>
  <div class="drawer-grid">
    <button class="drawer-item" onclick="P('analytics');closeDrawer()"><div class="drawer-item-icon">ğŸ“ˆ</div><div class="drawer-item-lbl">Analytics</div></button>
    <button class="drawer-item" onclick="P('visits');closeDrawer()"><div class="drawer-item-icon">ğŸ”</div><div class="drawer-item-lbl">Site Visits</div></button>
    <button class="drawer-item" onclick="P('blocks');closeDrawer()"><div class="drawer-item-icon">ğŸ˜</div><div class="drawer-item-lbl">Blocks</div></button>
    <button class="drawer-item" onclick="P('villages');closeDrawer()"><div class="drawer-item-icon">ğŸŒ¾</div><div class="drawer-item-lbl">Villages</div></button>
    <button class="drawer-item" onclick="P('houses');closeDrawer()"><div class="drawer-item-icon">ğŸ </div><div class="drawer-item-lbl">All Houses</div></button>
    <button class="drawer-item" onclick="P('stagnant');closeDrawer()"><div class="drawer-item-icon">âš ï¸</div><div class="drawer-item-lbl">Stagnant</div></button>
    <button class="drawer-item" onclick="P('pending');closeDrawer()"><div class="drawer-item-icon">ğŸ”´</div><div class="drawer-item-lbl">Pending</div></button>
    <button class="drawer-item" onclick="P('reports');closeDrawer()"><div class="drawer-item-icon">ğŸ“‹</div><div class="drawer-item-lbl">Reports</div></button>
    <button class="drawer-item" onclick="P('log');closeDrawer()"><div class="drawer-item-icon">ğŸ“</div><div class="drawer-item-lbl">Log</div></button>
    <button class="drawer-item" onclick="P('audit');closeDrawer()"><div class="drawer-item-icon">ğŸ”’</div><div class="drawer-item-lbl">Audit Trail</div></button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CAMERA MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="cam-modal">
  <div class="modal" style="max-width:480px">
    <div class="modal-hd">
      <span>ğŸ“· Capture Photo</span>
      <button class="modal-close" onclick="closeCamera()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="cam-wrap">
        <video id="cam-video" autoplay playsinline muted></video>
        <canvas id="cam-canvas"></canvas>
        <div class="cam-ts" id="cam-ts">ğŸ“… Loading...</div>
      </div>
      <img id="cam-preview" class="cam-preview" alt="Preview">
      <div class="cam-ctrl" id="cam-ctrl-live">
        <button class="btn btn-p" onclick="capturePhoto()">ğŸ“¸ Capture</button>
        <label class="btn btn-o" style="cursor:pointer">ğŸ“ From Gallery<input type="file" accept="image/*" style="display:none" onchange="galleryPhoto(this)"></label>
        <button class="btn btn-o" onclick="closeCamera()">âœ• Cancel</button>
      </div>
      <div class="cam-ctrl" id="cam-ctrl-preview" style="display:none">
        <button class="btn btn-green" onclick="confirmPhoto()">âœ… Use Photo</button>
        <button class="btn btn-o" onclick="retakePhoto()">ğŸ”„ Retake</button>
      </div>
      <div id="cam-ts-display" style="font-size:11px;color:var(--txm);margin-top:8px;text-align:center;font-family:DM Mono,monospace"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PHOTO VIEW MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="photo-view-modal">
  <div class="modal" style="max-width:600px">
    <div class="modal-hd"><span id="pvm-title">Photo</span><button class="modal-close" onclick="closeModal('photo-view-modal')">âœ•</button></div>
    <div class="modal-body" style="text-align:center">
      <img id="pvm-img" style="max-width:100%;border-radius:var(--rsm)">
      <div id="pvm-ts" style="font-size:11px;color:var(--txm);margin-top:8px;font-family:DM Mono,monospace"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STAFF MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="staff-modal">
  <div class="modal" style="max-width:500px">
    <div class="modal-hd"><span id="staff-modal-title">Add Staff</span><button class="modal-close" onclick="closeModal('staff-modal')">âœ•</button></div>
    <div class="modal-body">
      <div class="g2">
        <div class="fg"><label class="fl">Full Name *</label><input class="fi" id="sm-name" placeholder="e.g. M. Rajan"></div>
        <div class="fg"><label class="fl">Designation *</label>
          <select class="fsel" id="sm-desig">
            <option value="JE">Junior Engineer (JE)</option>
            <option value="AE">Assistant Engineer (AE)</option>
            <option value="EE">Executive Engineer (EE)</option>
            <option value="OV">Overseer</option>
            <option value="SI">Site Inspector</option>
          </select>
        </div>
      </div>
      <div class="g2">
        <div class="fg"><label class="fl">Phone</label><input class="fi" id="sm-phone" placeholder="Mobile number" type="tel"></div>
        <div class="fg"><label class="fl">Employee ID</label><input class="fi" id="sm-empid" placeholder="e.g. JE/MYL/012"></div>
      </div>
      <div class="fg"><label class="fl">Assigned Blocks (hold Ctrl/tap to select multiple)</label>
        <select class="fsel" id="sm-blocks" multiple style="height:100px;padding:6px">
          <option value="KOLLIDAM">KOLLIDAM</option><option value="KUTHALAM">KUTHALAM</option>
          <option value="MAYILADUTHURAI">MAYILADUTHURAI</option><option value="SEMBANARKOIL">SEMBANARKOIL</option>
          <option value="SIRKALI">SIRKALI</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Assigned Villages (comma-separated)</label>
        <input class="fi" id="sm-villages" placeholder="e.g. Achalpuram, Kothangudi"></div>
      <div class="fg"><label class="fl">Notes</label><input class="fi" id="sm-notes" placeholder="Additional info"></div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-p btn-full" onclick="saveStaff()">ğŸ’¾ Save Staff</button>
        <button class="btn btn-o" onclick="closeModal('staff-modal')" style="min-width:80px">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VISIT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="visit-modal">
  <div class="modal">
    <div class="modal-hd"><span>ğŸ” Log Site Visit</span><button class="modal-close" onclick="closeModal('visit-modal')">âœ•</button></div>
    <div class="modal-body">
      <div class="g2">
        <div class="fg"><label class="fl">Visit Date *</label><input type="date" class="fi" id="vm-date"></div>
        <div class="fg"><label class="fl">Engineer/Overseer *</label><select class="fsel" id="vm-eng"><option value="">â€” Select Staff â€”</option></select></div>
      </div>
      <div class="g2">
        <div class="fg"><label class="fl">Work ID</label><input class="fi" id="vm-wid" placeholder="Optional Work ID" list="wid-list"></div>
        <div class="fg"><label class="fl">Village</label><input class="fi" id="vm-vil" placeholder="Village name"></div>
      </div>
      <div class="fg"><label class="fl">Block</label><select class="fsel" id="vm-block">
        <option value="">â€” Select Block â€”</option>
        <option>KOLLIDAM</option><option>KUTHALAM</option><option>MAYILADUTHURAI</option><option>SEMBANARKOIL</option><option>SIRKALI</option>
      </select></div>
      <div class="card-hd" style="margin-top:14px;margin-bottom:8px">Quality Checklist (10-point Inspection)</div>
      <div id="visit-checklist"></div>
      <div class="fg" style="margin-top:14px"><label class="fl">Observations / Notes</label><textarea class="fta" id="vm-notes" placeholder="Describe findings, issues, actions neededâ€¦"></textarea></div>
      <div class="fg">
        <label class="fl">Site Photos</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap" id="vm-photos-wrap">
          <div class="photo-slot" onclick="openCameraFor('visit-photo')"><span>ğŸ“·</span><span>Add Photo</span></div>
        </div>
      </div>
      <button class="btn btn-p btn-full" onclick="saveVisit()">ğŸ’¾ Save Visit Record</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MATERIAL MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="mat-modal">
  <div class="modal">
    <div class="modal-hd"><span>ğŸ§± Issue Materials</span><button class="modal-close" onclick="closeModal('mat-modal')">âœ•</button></div>
    <div class="modal-body">
      <div class="alert al-i"><span>â„¹ï¸</span><div>Standards: <strong>Cement 130 bags</strong> Â· <strong>Steel 320 kg</strong> per house</div></div>
      <div class="g2">
        <div class="fg"><label class="fl">Issue Date *</label><input type="date" class="fi" id="mm-date"></div>
        <div class="fg"><label class="fl">Issue Type</label>
          <select class="fsel" id="mm-type">
            <option value="1st">1st Issue</option><option value="2nd">2nd Issue</option><option value="3rd">3rd Issue (Final)</option>
          </select>
        </div>
      </div>
      <div class="fg"><label class="fl">Work ID *</label>
        <input class="fi" id="mm-wid" placeholder="Enter Work ID" list="wid-list" oninput="autoFillMat()">
        <datalist id="wid-list"></datalist>
      </div>
      <div class="g2" id="mm-autofill" style="display:none">
        <div style="padding:10px;background:var(--bgh);border-radius:var(--rsm);font-size:12px;color:var(--txm);grid-column:1/-1">
          <strong id="mm-bene" style="color:var(--tx)"></strong><br>
          <span id="mm-villblock"></span>
        </div>
      </div>
      <div class="g2">
        <div class="fg"><label class="fl">Cement Issued (bags)</label><input class="fi" id="mm-cem" type="number" min="0" max="200" placeholder="e.g. 65"></div>
        <div class="fg"><label class="fl">Steel Issued (kg)</label><input class="fi" id="mm-steel" type="number" min="0" max="500" placeholder="e.g. 160"></div>
      </div>
      <div class="fg"><label class="fl">Sand Issued (loads)</label><input class="fi" id="mm-sand" type="number" min="0" placeholder="Optional"></div>
      <div class="fg"><label class="fl">Issued By (Staff)</label><select class="fsel" id="mm-staff"><option value="">â€” Select Staff â€”</option></select></div>
      <div class="fg">
        <label class="fl">Beneficiary Photo with Timestamp *</label>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-t btn-sm" onclick="openCameraFor('mat-photo')">ğŸ“· Take Photo</button>
          <label class="btn btn-o btn-sm" style="cursor:pointer">ğŸ“ Upload<input type="file" accept="image/*" style="display:none" onchange="uploadMatPhoto(this)"></label>
          <div id="mm-photo-preview"></div>
        </div>
        <div id="mm-ts-display" style="font-size:11px;color:var(--txm);margin-top:4px;font-family:DM Mono,monospace"></div>
      </div>
      <div class="fg">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px">
          <input type="checkbox" id="mm-ack" style="width:18px;height:18px">
          <span>Beneficiary acknowledged receipt (digital signature)</span>
        </label>
      </div>
      <div class="fg"><label class="fl">Notes</label><input class="fi" id="mm-notes" placeholder="Optional remarks"></div>
      <button class="btn btn-p btn-full" onclick="saveMaterial()">ğŸ’¾ Save Material Issue Record</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CERT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="cert-modal">
  <div class="modal" style="max-width:680px">
    <div class="modal-hd"><span>ğŸ… Completion Certificate</span>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm btn-p" onclick="window.print()">ğŸ–¨ï¸ Print</button>
        <button class="modal-close" onclick="closeModal('cert-modal')">âœ•</button>
      </div>
    </div>
    <div class="modal-body"><div id="cert-content"></div></div>
  </div>
</div>

<datalist id="wid-list-global"></datalist>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main-content">

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page active" id="page-dashboard">
  <div id="dash-empty" class="empty"><div class="ei">ğŸ“¤</div><h3>No Data Loaded</h3><p>Upload your OSMS report to begin monitoring.</p><br><button class="btn btn-p" onclick="P('upload')">â†’ Upload Now</button></div>
  <div id="dash-content" style="display:none">
    <div class="sgrid" id="stat-grid"></div>
    <div class="g2" style="margin-bottom:16px">
      <div class="card"><div class="card-hd">Overall Stage Breakdown</div><div id="completion-stacked"></div><div class="legend" id="stage-legend"></div></div>
      <div class="card"><div class="card-hd">Stage Distribution</div><div class="bc" id="stage-chart"></div></div>
    </div>
    <div class="g2">
      <div class="card"><div class="card-hd">Block-wise Completion</div><div class="bc" id="block-chart"></div></div>
      <div class="card"><div class="card-hd">Financial Overview</div><div id="amount-summary"></div></div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-upload">
  <div class="sec">Upload OSMS Data</div>
  <div class="g2" style="margin-bottom:22px">
    <div>
      <div class="uz" id="drop-zone">
        <input type="file" id="file-input" accept=".xls,.xlsx,.csv,.html,.htm" onchange="handleFile(this.files[0])">
        <div style="font-size:34px;margin-bottom:8px">ğŸ“‚</div>
        <div style="font-size:15px;font-weight:700;color:var(--tx)">Drop or tap to upload</div>
        <div style="font-size:12px;color:var(--txm);margin-top:3px">Supports multiple formats</div>
        <div class="fmt-chips">
          <span class="fchip fxls">ğŸ“— XLS</span><span class="fchip fxlsx">ğŸ“˜ XLSX</span>
          <span class="fchip fcsv">ğŸ“„ CSV</span><span class="fchip fhtml">ğŸŒ HTML</span>
        </div>
      </div>
      <div id="upload-status" style="margin-top:10px"></div>
    </div>
    <div class="card"><div class="card-hd">Upload Guide</div>
      <div style="font-size:13px;color:var(--txm);line-height:1.8">
        <p>ğŸ“— <strong>XLS/HTML</strong> â€” Direct OSMS portal export (HTML table format)</p>
        <p>ğŸ“˜ <strong>XLSX</strong> â€” Standard Excel (needs SheetJS via internet)</p>
        <p>ğŸ“„ <strong>CSV</strong> â€” Export from Excel/Google Sheets</p>
        <p>ğŸŒ <strong>HTML</strong> â€” Any HTML file with a data table</p>
        <hr style="border-color:var(--bor);margin:10px 0">
        <p>ğŸ”’ All data stored <strong>locally â€” never sent to any server</strong></p>
        <p>ğŸ“… Each upload saved as snapshot for time-tracking</p>
      </div>
    </div>
  </div>
  <div class="sec">Saved Snapshots</div>
  <div id="snapshot-list"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STAFF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-staff">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
    <div class="sec" style="margin:0">Staff Management</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-p" onclick="openStaffModal()">+ Add Staff</button>
      <button class="btn btn-o" onclick="P('visits')">ğŸ” Site Visits</button>
    </div>
  </div>
  <div class="sgrid" id="staff-summary-grid"></div>
  <div id="staff-list" class="g3"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MATERIALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-materials">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px">
    <div class="sec" style="margin:0">Material Issue Register</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-t" onclick="openMatModal()">+ Issue Materials</button>
      <button class="btn btn-o btn-sm" onclick="exportMaterials()">â¬‡ï¸ Export</button>
    </div>
  </div>
  <div class="sgrid" id="mat-summary-grid"></div>
  <div class="g2" style="margin-bottom:16px">
    <div class="card"><div class="card-hd">Cement Utilisation (per house: 130 bags)</div><div class="bc" id="mat-cem-chart"></div></div>
    <div class="card"><div class="card-hd">Steel Utilisation (per house: 320 kg)</div><div class="bc" id="mat-steel-chart"></div></div>
  </div>
  <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px">
    <select class="fsel" style="width:auto;min-width:120px" id="mat-block-filter" onchange="renderMaterials()"><option value="">All Blocks</option></select>
    <select class="fsel" style="width:auto" id="mat-type-filter" onchange="renderMaterials()">
      <option value="">All Types</option><option value="1st">1st Issue</option><option value="2nd">2nd Issue</option><option value="3rd">3rd Issue</option>
    </select>
  </div>
  <div class="srch"><span style="font-size:16px;color:var(--txm)">ğŸ”</span><input type="text" id="mat-search" placeholder="Search Work ID, Village, Beneficiaryâ€¦" oninput="renderMaterials()"></div>
  <div id="mat-list"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ANALYTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-analytics">
  <div class="sec">Analytics & Intelligence</div>
  <div class="sgrid" id="ana-summary"></div>
  <div class="g2" style="margin-bottom:16px">
    <div class="card"><div class="card-hd">Progress Trend (Snapshots Over Time)</div><div id="trend-chart"></div></div>
    <div class="card"><div class="card-hd">Predictive Completion</div><div id="pred-content"></div></div>
  </div>
  <div class="sec">Village Risk Scores</div>
  <div class="alert al-w"><span>âš ï¸</span><div>Risk score 0â€“100: based on completion rate, stagnant houses, and pending ratio. <strong>Red &gt;60 = High Risk</strong></div></div>
  <div class="srch"><span style="font-size:16px;color:var(--txm)">ğŸ”</span><input type="text" id="ana-search" placeholder="Search villagesâ€¦" oninput="renderAnalytics()"></div>
  <div id="risk-table"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SITE VISITS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-visits">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
    <div class="sec" style="margin:0">Site Visit Log</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-p" onclick="openVisitModal()">+ Log Visit</button>
      <button class="btn btn-o btn-sm" onclick="exportVisits()">â¬‡ï¸ Export</button>
    </div>
  </div>
  <div class="sgrid" id="visit-summary"></div>
  <div class="srch"><span style="font-size:16px;color:var(--txm)">ğŸ”</span><input type="text" id="visit-search" placeholder="Search by engineer, village, Work IDâ€¦" oninput="renderVisits()"></div>
  <div id="visit-list"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BLOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-blocks">
  <div class="sec">Block-wise Breakdown</div>
  <div id="blocks-content"><div class="empty"><div class="ei">ğŸ˜</div><h3>No data loaded</h3></div></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VILLAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-villages">
  <div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px">
    <div class="sec" style="margin:0">Village-wise Completion</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <select class="fsel" style="width:auto;min-width:120px" id="vil-blk" onchange="renderVillages()"><option value="">All Blocks</option></select>
      <select class="fsel" style="width:auto;min-width:120px" id="vil-sort" onchange="renderVillages()">
        <option value="pct-asc">Completion â†‘</option><option value="pct-desc">Completion â†“</option>
        <option value="name">Name A-Z</option><option value="total-desc">Total â†“</option>
      </select>
    </div>
  </div>
  <div class="srch"><span style="font-size:16px;color:var(--txm)">ğŸ”</span><input type="text" id="vil-srch" placeholder="Search villagesâ€¦" oninput="renderVillages()" autocomplete="off"></div>
  <div id="villages-content"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HOUSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-houses">
  <div style="display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px">
    <div class="sec" style="margin:0">All Houses</div>
    <div style="display:flex;flex-wrap:wrap;gap:8px">
      <select class="fsel" style="width:auto;min-width:120px" id="h-blk" onchange="renderHouses()"><option value="">All Blocks</option></select>
      <select class="fsel" style="width:auto;min-width:120px" id="h-stg" onchange="renderHouses()"><option value="">All Stages</option></select>
    </div>
  </div>
  <div class="srch"><span style="font-size:16px;color:var(--txm)">ğŸ”</span><input type="text" id="h-srch" placeholder="Search Work ID, Name, Villageâ€¦" oninput="renderHouses()" autocomplete="off"></div>
  <div id="houses-content"></div>
  <div id="houses-count" style="font-size:12px;color:var(--txm);margin-top:8px;text-align:right"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STAGNANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-stagnant">
  <div class="sec">Stagnant Houses</div>
  <div id="stagnant-content"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PENDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-pending">
  <div class="sec">Long Pending Houses (&gt;180 days)</div>
  <div class="alert al-w"><span>âš ï¸</span><div>Houses still pending since first uploaded snapshot, tracked against 180-day threshold.</div></div>
  <div id="pending-content"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ REPORTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-reports">
  <div class="sec">Reports & Export</div>
  <div class="g3" style="margin-bottom:22px">
    <div class="card" style="cursor:pointer;border-color:var(--bor);transition:border-color .2s" onclick="exportHousesCSV()" onmouseenter="this.style.borderColor='var(--gold)'" onmouseleave="this.style.borderColor='var(--bor)'">
      <div style="font-size:28px;margin-bottom:8px">ğŸ“„</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px">Houses CSV Export</div>
      <div style="font-size:12px;color:var(--txm)">All houses with stage, block, village, amount data</div>
    </div>
    <div class="card" style="cursor:pointer" onclick="exportMaterialsCSV()" onmouseenter="this.style.borderColor='var(--gold)'" onmouseleave="this.style.borderColor='var(--bor)'">
      <div style="font-size:28px;margin-bottom:8px">ğŸ§±</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px">Materials CSV Export</div>
      <div style="font-size:12px;color:var(--txm)">Cement, steel, sand issue register</div>
    </div>
    <div class="card" style="cursor:pointer" onclick="printSummaryReport()" onmouseenter="this.style.borderColor='var(--gold)'" onmouseleave="this.style.borderColor='var(--bor)'">
      <div style="font-size:28px;margin-bottom:8px">ğŸ–¨ï¸</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px">Monthly Summary Print</div>
      <div style="font-size:12px;color:var(--txm)">Printable district progress report</div>
    </div>
    <div class="card" style="cursor:pointer" onclick="exportVisitsCSV()" onmouseenter="this.style.borderColor='var(--gold)'" onmouseleave="this.style.borderColor='var(--bor)'">
      <div style="font-size:28px;margin-bottom:8px">ğŸ”</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px">Site Visits Export</div>
      <div style="font-size:12px;color:var(--txm)">All visit records with checklist scores</div>
    </div>
    <div class="card" style="cursor:pointer" onclick="exportStaffReport()" onmouseenter="this.style.borderColor='var(--gold)'" onmouseleave="this.style.borderColor='var(--bor)'">
      <div style="font-size:28px;margin-bottom:8px">ğŸ‘·</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px">Staff Performance</div>
      <div style="font-size:12px;color:var(--txm)">Engineer/overseer performance summary</div>
    </div>
    <div class="card" style="border-color:var(--gold);background:rgba(212,160,23,.04)">
      <div style="font-size:28px;margin-bottom:8px">ğŸ…</div>
      <div style="font-weight:700;font-size:14px;margin-bottom:4px">Completion Certificate</div>
      <div style="font-size:12px;color:var(--txm);margin-bottom:10px">Generate per Work ID</div>
      <input class="fi" id="cert-wid" placeholder="Enter Work ID" list="wid-list-global" style="margin-bottom:8px">
      <button class="btn btn-g btn-sm btn-full" onclick="generateCert()">Generate â†’</button>
    </div>
  </div>
  <div class="sec">Block-wise Summary Table</div>
  <div id="report-summary"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-log">
  <div class="sec" style="margin-bottom:14px">Add Progress Entry</div>
  <div class="card" style="margin-bottom:20px">
    <div class="g2">
      <div class="fg"><label class="fl">Date</label><input type="date" class="fi" id="log-date"></div>
      <div class="fg"><label class="fl">Category</label>
        <select class="fsel" id="log-cat">
          <option>Site Visit</option><option>Inspection</option><option>Review Meeting</option>
          <option>Issue Reported</option><option>Completion Notice</option><option>General Update</option>
        </select>
      </div>
    </div>
    <div class="g2">
      <div class="fg"><label class="fl">Block</label>
        <select class="fsel" id="log-blk"><option value="">All Blocks</option>
          <option>KOLLIDAM</option><option>KUTHALAM</option><option>MAYILADUTHURAI</option><option>SEMBANARKOIL</option><option>SIRKALI</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Village</label><input class="fi" id="log-vil" placeholder="Optional"></div>
    </div>
    <div class="fg"><label class="fl">Notes *</label><textarea class="fta" id="log-notes" placeholder="Progress observations, actions takenâ€¦"></textarea></div>
    <button class="btn btn-p btn-full" onclick="addLog()">ğŸ’¾ Save Entry</button>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
    <div class="sec" style="margin:0">Log Entries</div>
    <button class="btn btn-o btn-sm" onclick="exportLog()">â¬‡ï¸ Export CSV</button>
  </div>
  <div class="srch"><span style="font-size:16px;color:var(--txm)">ğŸ”</span><input type="text" id="log-srch" placeholder="Search entriesâ€¦" oninput="renderLog()" autocomplete="off"></div>
  <div id="log-list"></div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AUDIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="page" id="page-audit">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
    <div class="sec" style="margin:0">Audit Trail</div>
    <button class="btn btn-d btn-sm" onclick="clearAudit()">ğŸ—‘ Clear</button>
  </div>
  <div class="card" style="padding:0;overflow:hidden">
    <div id="audit-list" style="max-height:600px;overflow-y:auto"></div>
  </div>
</div>

</div><!-- /main-content -->
<footer style="text-align:center;padding:14px;font-size:11px;color:var(--txm);border-top:1px solid var(--bor);margin-top:16px">
  Kalaignarin Kanavu Illam Housing Monitor Â· Mayiladuthurai District, TN Â· Offline-First Â· v3.0
</footer>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CEM_STD = 130, STEEL_STD = 320, HOUSE_COST = 310000;
const CHECKLIST_ITEMS = [
  'Foundation depth adequate (min 4 feet)',
  'Plinth level correct (min 1.5 ft above ground)',
  'Wall thickness â‰¥ 230mm (9 inch brick)',
  'Window / door frames properly fixed',
  'Lintel level uniform throughout',
  'Roof slab thickness adequate (min 100mm)',
  'Waterproofing treatment applied',
  'Plastering quality good (no cracks)',
  'Electrical conduit pipes laid',
  'Overall site cleanliness & safety maintained'
];
const DESIG_MAP = {JE:'Junior Engineer',AE:'Assistant Engineer',EE:'Executive Engineer',OV:'Overseer',SI:'Site Inspector'};
const DESIG_CLS = {JE:'dJE',AE:'dAE',EE:'dEE',OV:'dOV',SI:'dSI'};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let theme = localStorage.getItem('kki_theme') || (window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');
applyTheme(theme);
document.getElementById('theme-btn').addEventListener('click',()=>{theme=theme==='light'?'dark':'light';applyTheme(theme);localStorage.setItem('kki_theme',theme)});
function applyTheme(t){document.documentElement.setAttribute('data-theme',t);document.getElementById('theme-lbl').textContent=t==='dark'?'ğŸŒ™':'â˜€ï¸'}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const APP = {
  snapshots:[], currentData:[], logs:[],
  staff:[],
  materials:[],  // {id,workId,block,village,beneficiary,date,cemQty,steelQty,sandQty,issueType,staffId,photo,photoTs,acknowledged,notes}
  visits:[],     // {id,workId,block,village,engineerId,date,checklist:[],notes,photos:[]}
  housePhotos:{},// workId â†’ {foundation,lintel,roof,completion}
  audit:[],      // {id,ts,icon,action,details}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAGE CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SC = {
  'Completed':{lbl:'Completed',col:'#22a86a',cls:'s-c'},
  'Physically Completed':{lbl:'Phys. Complete',col:'#60a5fa',cls:'s-p'},
  'Whitewash / Colourwash Progress':{lbl:'Whitewash',col:'#a78bfa',cls:'s-w'},
  'Plastering':{lbl:'Plastering',col:'#f87171',cls:'s-pl'},
  'Roof Laid':{lbl:'Roof Laid',col:'#f59e0b',cls:'s-r'},
};
const scol=s=>(SC[s]||{col:'#8892a4'}).col;
const scls=s=>(SC[s]||{cls:'s-o'}).cls;
const done=s=>s==='Completed'||s==='Physically Completed';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCAL STORAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function save(){
  try{
    localStorage.setItem('kki_snaps',JSON.stringify(APP.snapshots));
    localStorage.setItem('kki_logs',JSON.stringify(APP.logs));
    localStorage.setItem('kki_staff',JSON.stringify(APP.staff));
    localStorage.setItem('kki_mats',JSON.stringify(APP.materials));
    localStorage.setItem('kki_visits',JSON.stringify(APP.visits));
    localStorage.setItem('kki_audit',JSON.stringify(APP.audit));
  }catch(e){if(e.name==='QuotaExceededError')alert('âš ï¸ Storage full! Delete old snapshots or clear photos.');}
}
function load(){
  try{
    const keys={kki_snaps:'snapshots',kki_logs:'logs',kki_staff:'staff',kki_mats:'materials',kki_visits:'visits',kki_audit:'audit'};
    Object.entries(keys).forEach(([k,v])=>{const d=localStorage.getItem(k);if(d)APP[v]=JSON.parse(d);});
    if(APP.snapshots.length)APP.currentData=APP.snapshots[APP.snapshots.length-1].data;
  }catch(e){console.warn('Load error',e);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PAGE_ORDER=['dashboard','upload','staff','materials','analytics','visits','blocks','villages','houses','stagnant','pending','reports','log','audit'];
const RENDERS={dashboard:renderDash,upload:renderSnaps,staff:renderStaff,materials:renderMaterials,analytics:renderAnalytics,visits:renderVisits,blocks:renderBlocks,villages:renderVillages,houses:renderHouses,stagnant:renderStagnant,pending:renderPending,reports:renderReports,log:renderLog,audit:renderAudit};

function P(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  document.querySelectorAll('#desk-nav .nav-tab').forEach((t,i)=>t.classList.toggle('active',PAGE_ORDER[i]===id));
  document.querySelectorAll('.mob-tab[data-pg]').forEach(t=>t.classList.toggle('active',t.dataset.pg===id));
  RENDERS[id]?.();
}

function openDrawer(){document.getElementById('mdrawer').classList.add('open');document.getElementById('dov').classList.add('open');}
function closeDrawer(){document.getElementById('mdrawer').classList.remove('open');document.getElementById('dov').classList.remove('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIT LOGGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function audit(icon,action,details=''){
  APP.audit.unshift({id:Date.now(),ts:new Date().toISOString(),icon,action,details});
  if(APP.audit.length>500)APP.audit=APP.audit.slice(0,500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE UPLOAD & PARSING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleFile(file){
  if(!file)return;
  const ext=file.name.split('.').pop().toLowerCase();
  setUpStatus('â³ Reading fileâ€¦','al-i');
  const rd=new FileReader();
  if(ext==='xlsx'||ext==='xls'){
    rd.onload=e=>{
      if(typeof XLSX!=='undefined'){
        try{
          const wb=XLSX.read(e.target.result,{type:'array'});
          const ws=wb.Sheets[wb.SheetNames[0]];
          const rows=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
          const d=parseRows(rows);
          if(d&&d.length){finalizeUpload(d,file.name);return;}
        }catch(ex){/*fall through*/}
      }
      const tr=new FileReader();
      tr.onload=te=>{const d=parseHTML(te.target.result);if(d&&d.length)finalizeUpload(d,file.name);else setUpStatus('âŒ Could not parse. Check format.','al-d');};
      tr.readAsText(file,'UTF-8');
    };
    rd.readAsArrayBuffer(file);
  }else if(ext==='csv'){
    rd.onload=e=>{const d=parseCSV(e.target.result);if(d&&d.length)finalizeUpload(d,file.name);else setUpStatus('âŒ CSV parse failed.','al-d');};
    rd.readAsText(file,'UTF-8');
  }else{
    rd.onload=e=>{const d=parseHTML(e.target.result);if(d&&d.length)finalizeUpload(d,file.name);else setUpStatus('âŒ No table data found.','al-d');};
    rd.readAsText(file,'UTF-8');
  }
}

function setUpStatus(html,cls){document.getElementById('upload-status').innerHTML=`<div class="alert ${cls}">${html}</div>`;}

function finalizeUpload(data,name){
  const snap={id:Date.now(),date:new Date().toISOString(),label:name,data};
  APP.snapshots.push(snap);
  APP.currentData=data;
  save();updateHdr();populateFilters();populateWIDList();
  setUpStatus(`âœ… Loaded <strong>${data.length} houses</strong> from "${name}". Snapshot saved!`,'al-s');
  audit('ğŸ“¤','File Uploaded',`${data.length} houses from ${name}`);
  renderSnaps();
}

function parseHTML(content){
  const doc=new DOMParser().parseFromString(content,'text/html');
  const tables=doc.querySelectorAll('table');
  if(!tables.length)return null;
  let main=null,max=0;
  tables.forEach(t=>{if(t.rows.length>max){max=t.rows.length;main=t;}});
  const rows=Array.from(main.querySelectorAll('tr')).map(r=>Array.from(r.querySelectorAll('td,th')).map(c=>c.textContent.trim()));
  return parseRows(rows);
}

function parseCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  return parseRows(lines.map(line=>{const c=[];let cur='',inQ=false;for(const ch of line){if(ch==='"')inQ=!inQ;else if(ch===','&&!inQ){c.push(cur.trim());cur='';}else cur+=ch;}c.push(cur.trim());return c;}));
}

function parseRows(rows){
  if(!rows||rows.length<2)return null;
  const hdr=rows[0].map(h=>h.toLowerCase());
  const fc=(...ks)=>{for(const k of ks){const i=hdr.findIndex(h=>h.includes(k));if(i>=0)return i;}return -1;};
  let cB=fc('block'),cV=fc('village','town'),cH=fc('habitation'),cW=fc('work id','workid'),cN=fc('work name','beneficiary'),cA=fc('amount spent','amount spent sofar'),cS=fc('current stage','stage');
  if(cB<0)cB=1;if(cV<0)cV=2;if(cH<0)cH=3;if(cW<0)cW=4;if(cN<0)cN=9;if(cA<0)cA=15;if(cS<0)cS=16;
  const data=[];
  for(let i=1;i<rows.length;i++){
    const c=rows[i];if(!c||c.length<3)continue;
    const wid=(c[cW]||'').toString().trim();
    if(!wid||wid.length<3)continue;
    const stage=(c[cS]||'').trim();if(!stage)continue;
    data.push({workId:wid,block:(c[cB]||'').trim(),village:(c[cV]||'').trim(),habitation:(c[cH]||'').trim(),workName:(c[cN]||'').trim(),amountSpent:parseFloat((c[cA]||'').toString().replace(/,/g,''))||0,stage});
  }
  return data.length?data:null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function stats(data){
  const total=data.length,byBlock={},byVil={},byStage={};let completed=0,totalAmt=0;
  for(const h of data){
    if(done(h.stage))completed++;
    if(!byBlock[h.block])byBlock[h.block]={total:0,completed:0,stages:{}};
    byBlock[h.block].total++;if(done(h.stage))byBlock[h.block].completed++;
    byBlock[h.block].stages[h.stage]=(byBlock[h.block].stages[h.stage]||0)+1;
    if(!byVil[h.village])byVil[h.village]={block:h.block,total:0,completed:0,stages:{}};
    byVil[h.village].total++;if(done(h.stage))byVil[h.village].completed++;
    byVil[h.village].stages[h.stage]=(byVil[h.village].stages[h.stage]||0)+1;
    byStage[h.stage]=(byStage[h.stage]||0)+1;
    totalAmt+=h.amountSpent||0;
  }
  return{total,completed,pending:total-completed,pct:total?Math.round(completed*100/total):0,byBlock,byVil,byStage,totalAmt};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const grpBy=(arr,k)=>arr.reduce((a,d)=>{a[d[k]]=(a[d[k]]||0)+1;return a;},{});
const shortName=n=>n.replace(/Construction of New House Under Kalaignarin Kanavu Illam for\s*/i,'').trim();
const fmt=n=>n.toLocaleString('en-IN',{maximumFractionDigits:0});
const stk=(stages,total)=>([['Completed','#22a86a'],['Physically Completed','#3b82f6'],['Whitewash / Colourwash Progress','#8b5cf6'],['Plastering','#ef4444'],['Roof Laid','#f59e0b']]).map(([s,c])=>{const cnt=stages[s]||0;if(!cnt)return'';return`<div class="stkseg" style="width:${cnt*100/total}%;background:${c}" title="${s}: ${cnt}"></div>`;}).join('');
function pBar(pct,cls){return`<div class="pb"><div class="pf ${cls}" style="width:${pct}%"></div></div>`;}
function riskCls(r){return r<=30?'risk-low':r<=60?'risk-med':'risk-high';}
function riskScore(vd,stagnantMap){
  const pct=vd.total?vd.completed*100/vd.total:0;
  const stagnantPenalty=stagnantMap?Math.round((stagnantMap/vd.total)*30):0;
  return Math.min(100,Math.round((100-pct)*0.7+stagnantPenalty));
}
function bcBar(label,val,max,color,valTxt){
  const pct=max?Math.round(val*100/max):0;
  return`<div class="br"><div class="bl" title="${label}">${label}</div><div class="bt"><div class="bf" style="width:${pct}%;background:${color}">${pct>8?pct+'%':''}</div></div><div class="bv">${valTxt||val}</div></div>`;
}
function csvDownload(rows,filename){
  const blob=new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;a.click();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDash(){
  if(!APP.currentData.length){document.getElementById('dash-empty').style.display='block';document.getElementById('dash-content').style.display='none';return;}
  document.getElementById('dash-empty').style.display='none';document.getElementById('dash-content').style.display='block';
  const s=stats(APP.currentData);
  const roof=s.byStage['Roof Laid']||0;
  const plaster=(s.byStage['Plastering']||0)+(s.byStage['Whitewash / Colourwash Progress']||0);
  document.getElementById('stat-grid').innerHTML=`
    <div class="sc cn"><div class="si">ğŸ˜ï¸</div><div class="sv">${s.total.toLocaleString()}</div><div class="sl">Total Houses</div>${pBar(100,'pn')}</div>
    <div class="sc cg"><div class="si">âœ…</div><div class="sv">${s.completed.toLocaleString()}</div><div class="sl">Completed</div><div class="sp good">${s.pct}% done</div>${pBar(s.pct,'pg')}</div>
    <div class="sc cs"><div class="si">â³</div><div class="sv">${s.pending.toLocaleString()}</div><div class="sl">Pending</div><div class="sp warn">${100-s.pct}% left</div>${pBar(100-s.pct,'po')}</div>
    <div class="sc ct"><div class="si">ğŸ—ï¸</div><div class="sv">${roof}</div><div class="sl">Roof Laid</div>${pBar(s.total?Math.round(roof*100/s.total):0,'pt')}</div>
    <div class="sc cr"><div class="si">ğŸª£</div><div class="sv">${plaster}</div><div class="sl">Plastering/Wash</div>${pBar(s.total?Math.round(plaster*100/s.total):0,'pr')}</div>
    <div class="sc cp"><div class="si">ğŸ’°</div><div class="sv">â‚¹${(s.totalAmt/1e7).toFixed(1)}Cr</div><div class="sl">Amount Spent</div></div>
  `;
  const ORDER=[['Completed','#22a86a'],['Physically Completed','#3b82f6'],['Whitewash / Colourwash Progress','#8b5cf6'],['Plastering','#ef4444'],['Roof Laid','#f59e0b']];
  document.getElementById('completion-stacked').innerHTML='<div class="stkbar">'+ORDER.map(([st,c])=>{const cnt=s.byStage[st]||0;const pct=s.total?cnt*100/s.total:0;if(pct<.3)return'';return`<div class="stkseg" style="width:${pct}%;background:${c}" title="${st}: ${cnt}">${pct>6?cnt:''}</div>`;}).join('')+'</div>';
  document.getElementById('stage-legend').innerHTML=ORDER.map(([st,c])=>{const cnt=s.byStage[st]||0;if(!cnt)return'';return`<div class="li"><div class="ld" style="background:${c}"></div>${(SC[st]||{lbl:st}).lbl}: ${cnt}</div>`;}).join('');
  document.getElementById('stage-chart').innerHTML=Object.entries(s.byStage).sort((a,b)=>b[1]-a[1]).map(([st,cnt])=>bcBar((SC[st]||{lbl:st}).lbl,cnt,s.total,scol(st),cnt)).join('');
  document.getElementById('block-chart').innerHTML=Object.entries(s.byBlock).sort((a,b)=>b[1].total-a[1].total).map(([bl,b])=>{const pct=Math.round(b.completed*100/b.total);return bcBar(bl,pct,100,pct>80?'#22a86a':pct>50?'#f59e0b':'#ef4444',`${b.completed}/${b.total}`);}).join('');
  const sanc=APP.currentData.length*HOUSE_COST,spPct=Math.round(s.totalAmt*100/sanc);
  document.getElementById('amount-summary').innerHTML=`
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--txm)">Sanctioned</span><span style="font-weight:600">â‚¹${(sanc/1e7).toFixed(2)} Cr</span></div>
      <div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--txm)">Spent</span><span style="font-weight:600;color:var(--teal-light)">â‚¹${(s.totalAmt/1e7).toFixed(2)} Cr</span></div>
      <div style="display:flex;justify-content:space-between;font-size:13px"><span style="color:var(--txm)">Balance</span><span style="font-weight:600;color:var(--saffron)">â‚¹${((sanc-s.totalAmt)/1e7).toFixed(2)} Cr</span></div>
    </div>
    <div class="pb" style="height:10px"><div class="pf pt" style="width:${Math.min(spPct,100)}%"></div></div>
    <div style="font-size:11px;color:var(--txm);margin-top:3px">${spPct}% utilised</div>
    <hr style="border-color:var(--bor);margin:10px 0">
    <div style="font-size:12px;color:var(--txm);line-height:1.8">
      <div>ğŸ“ ${Object.keys(s.byBlock).length} Blocks Â· ${Object.keys(s.byVil).length} Villages</div>
      <div>ğŸ‘· ${APP.staff.length} Staff Â· ğŸ§± ${APP.materials.length} Material Records</div>
      <div>ğŸ“ ${APP.snapshots.length} snapshot${APP.snapshots.length===1?'':'s'}</div>
      <div>ğŸ“… ${APP.snapshots.length?'Last: '+new Date(APP.snapshots[APP.snapshots.length-1].date).toLocaleString('en-IN',{dateStyle:'medium',timeStyle:'short'}):'â€”'}</div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SNAPSHOTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSnaps(){
  const el=document.getElementById('snapshot-list');
  if(!APP.snapshots.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“‚</div><h3>No snapshots yet</h3><p>Upload a file to create the first snapshot.</p></div>';return;}
  el.innerHTML=APP.snapshots.map((snap,i)=>{
    const s=stats(snap.data);const isActive=i===APP.snapshots.length-1;
    return`<div class="snap-item" style="${isActive?'border-color:var(--gold);background:rgba(212,160,23,.05)':''}">
      <div class="snap-dot" style="background:${isActive?'var(--gold)':'var(--teal-light)'}"></div>
      <div class="snap-info">
        <div class="snap-date">${new Date(snap.date).toLocaleString('en-IN',{dateStyle:'medium',timeStyle:'short'})} ${isActive?'<span style="background:rgba(34,168,106,.15);color:var(--green-light);padding:1px 7px;border-radius:10px;font-size:10px;font-weight:700">ACTIVE</span>':''}</div>
        <div class="snap-meta">ğŸ“ ${snap.label} Â· ğŸ  ${snap.data.length} Â· âœ… ${s.completed} (${s.pct}%)</div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0">
        <button class="btn btn-o btn-sm" onclick="activateSnap(${i})">ğŸ“Š</button>
        <button class="btn btn-d btn-sm" onclick="deleteSnap(${i})">ğŸ—‘</button>
      </div>
    </div>`;
  }).join('');
}

function activateSnap(i){APP.currentData=APP.snapshots[i].data;updateHdr();populateFilters();populateWIDList();P('dashboard');}
function deleteSnap(i){if(!confirm('Delete this snapshot?'))return;APP.snapshots.splice(i,1);APP.currentData=APP.snapshots.length?APP.snapshots[APP.snapshots.length-1].data:[];save();updateHdr();renderSnaps();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAFF MODULE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let editingStaffId=null;

function openStaffModal(id){
  editingStaffId=id||null;
  document.getElementById('staff-modal-title').textContent=id?'Edit Staff':'Add Staff';
  const s=id?APP.staff.find(x=>x.id===id):{};
  document.getElementById('sm-name').value=s.name||'';
  document.getElementById('sm-desig').value=s.desig||'JE';
  document.getElementById('sm-phone').value=s.phone||'';
  document.getElementById('sm-empid').value=s.empid||'';
  document.getElementById('sm-notes').value=s.notes||'';
  document.getElementById('sm-villages').value=s.villages||'';
  Array.from(document.getElementById('sm-blocks').options).forEach(o=>o.selected=(s.blocks||[]).includes(o.value));
  document.getElementById('staff-modal').classList.add('open');
}

function saveStaff(){
  const name=document.getElementById('sm-name').value.trim();
  if(!name){alert('Name is required');return;}
  const blocks=Array.from(document.getElementById('sm-blocks').selectedOptions).map(o=>o.value);
  const obj={
    id:editingStaffId||Date.now(),
    name,desig:document.getElementById('sm-desig').value,
    phone:document.getElementById('sm-phone').value.trim(),
    empid:document.getElementById('sm-empid').value.trim(),
    blocks,
    villages:document.getElementById('sm-villages').value.trim(),
    notes:document.getElementById('sm-notes').value.trim(),
    addedDate:new Date().toISOString()
  };
  if(editingStaffId){const i=APP.staff.findIndex(x=>x.id===editingStaffId);if(i>=0)APP.staff[i]=obj;}
  else APP.staff.push(obj);
  audit('ğŸ‘·',editingStaffId?'Staff Updated':'Staff Added',`${obj.name} (${DESIG_MAP[obj.desig]||obj.desig})`);
  save();closeModal('staff-modal');renderStaff();populateStaffDropdowns();
}

function deleteStaff(id){
  if(!confirm('Delete this staff member?'))return;
  APP.staff=APP.staff.filter(s=>s.id!==id);
  audit('ğŸ—‘','Staff Deleted','');
  save();renderStaff();populateStaffDropdowns();
}

function staffStats(s){
  if(!APP.currentData.length)return{total:0,completed:0,pct:0,villages:[]};
  const vils=s.villages?s.villages.split(',').map(v=>v.trim()).filter(Boolean):[];
  const blks=s.blocks||[];
  const houses=APP.currentData.filter(h=>(blks.includes(h.block)||vils.some(v=>h.village.toLowerCase().includes(v.toLowerCase()))));
  const completed=houses.filter(h=>done(h.stage)).length;
  const uniqueVils=[...new Set(houses.map(h=>h.village))];
  return{total:houses.length,completed,pct:houses.length?Math.round(completed*100/houses.length):0,villages:uniqueVils};
}

function renderStaff(){
  const el=document.getElementById('staff-list');
  const sg=document.getElementById('staff-summary-grid');
  if(!APP.staff.length){
    sg.innerHTML='';
    el.innerHTML=`<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ‘·</div><h3>No staff added yet</h3><p>Add engineers and overseers to track their performance.</p><br><button class="btn btn-p" onclick="openStaffModal()">+ Add First Staff</button></div>`;
    return;
  }
  const JEs=APP.staff.filter(s=>s.desig==='JE').length;
  const AEs=APP.staff.filter(s=>s.desig==='AE').length;
  const OVs=APP.staff.filter(s=>s.desig==='OV').length;
  sg.innerHTML=`
    <div class="sc cn"><div class="si">ğŸ‘·</div><div class="sv">${APP.staff.length}</div><div class="sl">Total Staff</div></div>
    <div class="sc cb"><div class="si">ğŸ”§</div><div class="sv">${JEs}</div><div class="sl">Junior Engineers</div></div>
    <div class="sc cg"><div class="si">âš™ï¸</div><div class="sv">${AEs}</div><div class="sl">Asst. Engineers</div></div>
    <div class="sc co"><div class="si">ğŸ—ï¸</div><div class="sv">${OVs}</div><div class="sl">Overseers/Inspectors</div></div>
  `;
  el.innerHTML=APP.staff.map(s=>{
    const st=staffStats(s);
    const pctCls=st.pct>80?'pg':st.pct>50?'po':'pr';
    const tcol=st.pct>80?'var(--green-light)':st.pct>50?'var(--saffron)':'var(--red-light)';
    const initials=s.name.split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2);
    return`<div class="staff-card">
      <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px">
        <div class="staff-avatar">${initials}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:14px;color:var(--tx)">${s.name}</div>
          <span class="desig-badge ${DESIG_CLS[s.desig]||'dSI'}">${DESIG_MAP[s.desig]||s.desig}</span>
          ${s.empid?`<div style="font-size:11px;color:var(--txm);margin-top:2px">ID: ${s.empid}</div>`:''}
        </div>
        <div style="display:flex;gap:4px">
          <button class="btn btn-o btn-sm" onclick="openStaffModal(${s.id})">âœï¸</button>
          <button class="btn btn-d btn-sm" onclick="deleteStaff(${s.id})">ğŸ—‘</button>
        </div>
      </div>
      ${s.phone?`<div style="font-size:12px;color:var(--txm);margin-bottom:8px">ğŸ“ ${s.phone}</div>`:''}
      ${s.blocks&&s.blocks.length?`<div style="font-size:11px;color:var(--txm);margin-bottom:6px">ğŸ˜ Blocks: ${s.blocks.join(', ')}</div>`:''}
      ${s.villages?`<div style="font-size:11px;color:var(--txm);margin-bottom:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${s.villages}">ğŸŒ¾ ${s.villages}</div>`:''}
      <hr style="border-color:var(--bor);margin:10px 0">
      <div class="g2" style="gap:8px;margin-bottom:8px">
        <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:var(--sv);font-family:DM Mono,monospace">${st.total}</div><div style="font-size:10px;color:var(--txm)">Assigned</div></div>
        <div style="text-align:center"><div style="font-size:18px;font-weight:700;color:${tcol};font-family:DM Mono,monospace">${st.pct}%</div><div style="font-size:10px;color:var(--txm)">Completion</div></div>
      </div>
      <div class="pb"><div class="pf ${pctCls}" style="width:${st.pct}%"></div></div>
      <div style="font-size:11px;color:var(--txm);margin-top:6px">${st.completed}/${st.total} completed Â· ${st.villages.length} villages</div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMERA MODULE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let camStream=null,camCallback=null,capturedPhotoData=null,camContext='';

function openCameraFor(ctx,callback){
  camContext=ctx;camCallback=callback||null;
  capturedPhotoData=null;
  document.getElementById('cam-modal').classList.add('open');
  document.getElementById('cam-preview').style.display='none';
  document.getElementById('cam-ctrl-live').style.display='flex';
  document.getElementById('cam-ctrl-preview').style.display='none';
  document.getElementById('cam-ts-display').textContent='';
  const video=document.getElementById('cam-video');
  video.style.display='block';
  if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
    navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false})
      .then(stream=>{camStream=stream;video.srcObject=stream;startTsUpdate();})
      .catch(()=>{video.style.display='none';document.getElementById('cam-ts').textContent='ğŸ“· Camera unavailable â€” use Gallery above';});
  }else{video.style.display='none';document.getElementById('cam-ts').textContent='ğŸ“· Camera not supported â€” use Gallery above';}
}

function startTsUpdate(){
  if(window._tsInt)clearInterval(window._tsInt);
  window._tsInt=setInterval(()=>{
    const el=document.getElementById('cam-ts');
    if(el)el.textContent='ğŸ“… '+new Date().toLocaleString('en-IN',{dateStyle:'short',timeStyle:'medium'});
  },1000);
}

function capturePhoto(){
  const video=document.getElementById('cam-video');
  if(!video.srcObject&&!video.videoWidth){alert('Camera not ready. Use Gallery instead.');return;}
  const canvas=document.createElement('canvas');
  canvas.width=video.videoWidth||640;canvas.height=video.videoHeight||480;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  const now=new Date();
  const ts=now.toLocaleString('en-IN',{dateStyle:'short',timeStyle:'medium'});
  ctx.fillStyle='rgba(0,0,0,.72)';ctx.fillRect(0,canvas.height-36,canvas.width,36);
  ctx.fillStyle='#fff';ctx.font='bold 13px monospace';
  ctx.fillText('ğŸ“… '+ts+'  |  KKI Housing Monitor',10,canvas.height-11);
  capturedPhotoData={data:canvas.toDataURL('image/jpeg',.58),ts:now.toISOString()};
  showPreview(capturedPhotoData.data,ts);
}

function galleryPhoto(input){
  if(!input.files[0])return;
  const rd=new FileReader();
  rd.onload=e=>{
    const now=new Date();
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=img.width;canvas.height=img.height;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0);
      const ts=now.toLocaleString('en-IN',{dateStyle:'short',timeStyle:'medium'});
      ctx.fillStyle='rgba(0,0,0,.72)';ctx.fillRect(0,canvas.height-36,canvas.width,36);
      ctx.fillStyle='#fff';ctx.font='bold 13px monospace';
      ctx.fillText('ğŸ“… '+ts+'  |  KKI Housing Monitor',10,canvas.height-11);
      capturedPhotoData={data:canvas.toDataURL('image/jpeg',.58),ts:now.toISOString()};
      showPreview(capturedPhotoData.data,ts);
    };
    img.src=e.target.result;
  };
  rd.readAsDataURL(input.files[0]);
}

function showPreview(dataUrl,ts){
  if(window._tsInt)clearInterval(window._tsInt);
  const prev=document.getElementById('cam-preview');
  prev.src=dataUrl;prev.style.display='block';
  document.getElementById('cam-video').style.display='none';
  document.getElementById('cam-ctrl-live').style.display='none';
  document.getElementById('cam-ctrl-preview').style.display='flex';
  document.getElementById('cam-ts-display').textContent='Captured: '+ts;
}

function confirmPhoto(){
  if(!capturedPhotoData)return;
  stopCamera();
  if(camContext==='mat-photo'){
    document.getElementById('mm-ts-display').textContent='ğŸ“… Captured: '+new Date(capturedPhotoData.ts).toLocaleString('en-IN');
    document.getElementById('mm-photo-preview').innerHTML=`<img src="${capturedPhotoData.data}" class="mat-photo" onclick="viewPhoto('${encodeURIComponent(capturedPhotoData.data)}','Beneficiary Photo')">`;
    window._matPhoto=capturedPhotoData;
  }else if(camContext==='visit-photo'){
    addVisitPhoto(capturedPhotoData.data);
  }else if(camCallback){camCallback(capturedPhotoData);}
  closeCamera();
}

function retakePhoto(){
  capturedPhotoData=null;
  const video=document.getElementById('cam-video');video.style.display='block';
  document.getElementById('cam-preview').style.display='none';
  document.getElementById('cam-ctrl-live').style.display='flex';
  document.getElementById('cam-ctrl-preview').style.display='none';
  document.getElementById('cam-ts-display').textContent='';
  startTsUpdate();
}

function stopCamera(){
  if(camStream){camStream.getTracks().forEach(t=>t.stop());camStream=null;}
  if(window._tsInt)clearInterval(window._tsInt);
}

function closeCamera(){stopCamera();document.getElementById('cam-modal').classList.remove('open');}

function viewPhoto(dataOrEncoded,title){
  const data=dataOrEncoded.startsWith('data:')?dataOrEncoded:decodeURIComponent(dataOrEncoded);
  document.getElementById('pvm-title').textContent=title||'Photo';
  document.getElementById('pvm-img').src=data;
  document.getElementById('pvm-ts').textContent='';
  document.getElementById('photo-view-modal').classList.add('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MATERIAL REGISTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window._matPhoto=null;

function openMatModal(){
  window._matPhoto=null;
  document.getElementById('mm-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('mm-wid').value='';
  document.getElementById('mm-cem').value='';
  document.getElementById('mm-steel').value='';
  document.getElementById('mm-sand').value='';
  document.getElementById('mm-notes').value='';
  document.getElementById('mm-ack').checked=false;
  document.getElementById('mm-photo-preview').innerHTML='';
  document.getElementById('mm-ts-display').textContent='';
  document.getElementById('mm-autofill').style.display='none';
  document.getElementById('mat-modal').classList.add('open');
}

function autoFillMat(){
  const wid=document.getElementById('mm-wid').value.trim();
  const house=APP.currentData.find(h=>h.workId===wid);
  const af=document.getElementById('mm-autofill');
  if(house){
    document.getElementById('mm-bene').textContent=shortName(house.workName);
    document.getElementById('mm-villblock').textContent=`${house.village} Â· ${house.block} Â· ${house.stage}`;
    af.style.display='block';
  }else{af.style.display='none';}
}

function uploadMatPhoto(input){
  if(!input.files[0])return;
  const rd=new FileReader();
  rd.onload=e=>{
    const now=new Date();
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=Math.min(img.width,800);canvas.height=Math.round(img.height*canvas.width/img.width);
      const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,canvas.width,canvas.height);
      const ts=now.toLocaleString('en-IN',{dateStyle:'short',timeStyle:'medium'});
      ctx.fillStyle='rgba(0,0,0,.72)';ctx.fillRect(0,canvas.height-36,canvas.width,36);
      ctx.fillStyle='#fff';ctx.font='bold 13px monospace';
      ctx.fillText('ğŸ“… '+ts+'  |  KKI Housing Monitor',10,canvas.height-11);
      const data=canvas.toDataURL('image/jpeg',.55);
      window._matPhoto={data,ts:now.toISOString()};
      document.getElementById('mm-ts-display').textContent='ğŸ“… Captured: '+ts;
      document.getElementById('mm-photo-preview').innerHTML=`<img src="${data}" class="mat-photo" onclick="viewPhoto('${encodeURIComponent(data)}','Beneficiary Photo')">`;
    };img.src=e.target.result;
  };
  rd.readAsDataURL(input.files[0]);
}

function saveMaterial(){
  const wid=document.getElementById('mm-wid').value.trim();
  if(!wid){alert('Work ID is required');return;}
  const cemQty=parseFloat(document.getElementById('mm-cem').value)||0;
  const steelQty=parseFloat(document.getElementById('mm-steel').value)||0;
  if(!cemQty&&!steelQty){alert('Enter at least cement or steel quantity');return;}
  const house=APP.currentData.find(h=>h.workId===wid);
  const rec={
    id:Date.now(),workId:wid,
    block:house?house.block:'',village:house?house.village:'',
    beneficiary:house?shortName(house.workName):'',
    date:document.getElementById('mm-date').value,
    cemQty,steelQty,sandQty:parseFloat(document.getElementById('mm-sand').value)||0,
    issueType:document.getElementById('mm-type').value,
    staffId:document.getElementById('mm-staff').value,
    photo:window._matPhoto?window._matPhoto.data:null,
    photoTs:window._matPhoto?window._matPhoto.ts:null,
    acknowledged:document.getElementById('mm-ack').checked,
    acknowledgedDate:document.getElementById('mm-ack').checked?new Date().toISOString():null,
    notes:document.getElementById('mm-notes').value.trim(),
  };
  APP.materials.push(rec);
  audit('ğŸ§±','Material Issued',`WID:${wid} Cem:${cemQty}bags Steel:${steelQty}kg`);
  save();closeModal('mat-modal');renderMaterials();
}

function deleteMaterial(id){
  if(!confirm('Delete this material record?'))return;
  APP.materials=APP.materials.filter(m=>m.id!==id);
  audit('ğŸ—‘','Material Record Deleted','');
  save();renderMaterials();
}

function renderMaterials(){
  const sg=document.getElementById('mat-summary-grid');
  const totalCem=APP.materials.reduce((a,m)=>a+m.cemQty,0);
  const totalSteel=APP.materials.reduce((a,m)=>a+m.steelQty,0);
  const totalHouses=APP.currentData.length||1;
  const avgCem=(totalCem/Math.max(APP.materials.length,1)).toFixed(0);
  const avgSteel=(totalSteel/Math.max(APP.materials.length,1)).toFixed(0);
  sg.innerHTML=`
    <div class="sc cn"><div class="si">ğŸ“‹</div><div class="sv">${APP.materials.length}</div><div class="sl">Issue Records</div></div>
    <div class="sc cg"><div class="si">ğŸªµ</div><div class="sv">${totalCem}</div><div class="sl">Total Cement (bags)</div><div class="sp">${Math.round(totalCem*100/(totalHouses*CEM_STD))}% of standard</div></div>
    <div class="sc ct"><div class="si">ğŸ”©</div><div class="sv">${totalSteel}</div><div class="sl">Total Steel (kg)</div><div class="sp">${Math.round(totalSteel*100/(totalHouses*STEEL_STD))}% of standard</div></div>
    <div class="sc co"><div class="si">âœ…</div><div class="sv">${APP.materials.filter(m=>m.acknowledged).length}</div><div class="sl">Acknowledged</div></div>
  `;
  // Charts by block
  const byBlock={};
  APP.materials.forEach(m=>{
    if(!byBlock[m.block])byBlock[m.block]={cem:0,steel:0,cnt:0};
    byBlock[m.block].cem+=m.cemQty;byBlock[m.block].steel+=m.steelQty;byBlock[m.block].cnt++;
  });
  const maxC=Math.max(...Object.values(byBlock).map(b=>b.cem),1);
  const maxS=Math.max(...Object.values(byBlock).map(b=>b.steel),1);
  document.getElementById('mat-cem-chart').innerHTML=Object.entries(byBlock).sort((a,b)=>b[1].cem-a[1].cem).map(([bl,b])=>bcBar(bl,b.cem,maxC,'#22a86a',`${b.cem}bg`)).join('')||'<div style="color:var(--txm);font-size:12px">No records yet</div>';
  document.getElementById('mat-steel-chart').innerHTML=Object.entries(byBlock).sort((a,b)=>b[1].steel-a[1].steel).map(([bl,b])=>bcBar(bl,b.steel,maxS,'#60a5fa',`${b.steel}kg`)).join('')||'<div style="color:var(--txm);font-size:12px">No records yet</div>';
  // Filter
  const bfil=document.getElementById('mat-block-filter').value;
  const tfil=document.getElementById('mat-type-filter').value;
  const srch=(document.getElementById('mat-search').value||'').toLowerCase();
  let filtered=APP.materials.filter(m=>
    (!bfil||m.block===bfil)&&(!tfil||m.issueType===tfil)&&
    (!srch||`${m.workId} ${m.village} ${m.beneficiary}`.toLowerCase().includes(srch))
  ).sort((a,b)=>b.id-a.id);
  const el=document.getElementById('mat-list');
  if(!filtered.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ§±</div><h3>No records found</h3></div>';return;}
  el.innerHTML=filtered.map(m=>{
    const cemPct=Math.min(100,Math.round(m.cemQty*100/CEM_STD));
    const stPct=Math.min(100,Math.round(m.steelQty*100/STEEL_STD));
    const matFinPct=Math.round((cemPct+stPct)/2);
    return`<div class="mat-row">
      <div style="display:flex;gap:10px;align-items:flex-start">
        ${m.photo?`<img src="${m.photo}" class="mat-photo" onclick="viewPhoto('${encodeURIComponent(m.photo)}','Beneficiary â€“ ${m.workId}')">`:
          '<div style="width:56px;height:56px;border:2px dashed var(--bor);border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">ğŸ“·</div>'}
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px">
            <div>
              <span style="font-family:DM Mono,monospace;font-size:11px;color:var(--txm)">${m.workId}</span>
              <span style="display:inline-block;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:700;background:rgba(37,99,235,.15);color:#60a5fa;margin-left:6px">${m.issueType} Issue</span>
              ${m.acknowledged?'<span style="display:inline-block;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:700;background:rgba(34,168,106,.15);color:#22a86a;margin-left:4px">âœ… Ack</span>':''}
            </div>
            <div style="display:flex;gap:5px">
              <button class="btn btn-d btn-sm" onclick="deleteMaterial(${m.id})">ğŸ—‘</button>
            </div>
          </div>
          <div style="font-weight:600;font-size:13px;margin:3px 0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.beneficiary||m.workId}</div>
          <div style="font-size:11px;color:var(--txm);margin-bottom:6px">ğŸ“… ${m.date} Â· ğŸ“ ${m.village} Â· ${m.block}</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:6px">
            <div><span style="font-size:11px;color:var(--txm)">Cement: </span><strong style="font-size:12px">${m.cemQty} bags</strong> <span style="font-size:10px;color:${cemPct>=100?'var(--green-light)':'var(--saffron)'}">(${cemPct}%)</span></div>
            <div><span style="font-size:11px;color:var(--txm)">Steel: </span><strong style="font-size:12px">${m.steelQty} kg</strong> <span style="font-size:10px;color:${stPct>=100?'var(--green-light)':'var(--saffron)'}">(${stPct}%)</span></div>
            ${m.sandQty?`<div><span style="font-size:11px;color:var(--txm)">Sand: </span><strong style="font-size:12px">${m.sandQty} loads</strong></div>`:''}
          </div>
          <div style="font-size:11px;color:var(--txm);margin-bottom:4px">Material Financial Progress: <strong style="color:${matFinPct>=80?'var(--green-light)':matFinPct>=50?'var(--saffron)':'var(--red-light)'}">${matFinPct}%</strong></div>
          <div class="pb"><div class="pf ${matFinPct>=80?'pg':matFinPct>=50?'po':'pr'}" style="width:${matFinPct}%"></div></div>
          ${m.notes?`<div style="font-size:11px;color:var(--txm);margin-top:4px">ğŸ“ ${m.notes}</div>`:''}
        </div>
      </div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SITE VISITS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let visitPhotos=[];

function openVisitModal(){
  visitPhotos=[];
  document.getElementById('vm-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('vm-wid').value='';
  document.getElementById('vm-vil').value='';
  document.getElementById('vm-block').value='';
  document.getElementById('vm-notes').value='';
  document.getElementById('vm-eng').value='';
  renderVisitChecklist();
  renderVisitPhotoSlots();
  document.getElementById('visit-modal').classList.add('open');
}

function renderVisitChecklist(){
  document.getElementById('visit-checklist').innerHTML=CHECKLIST_ITEMS.map((item,i)=>`
    <div class="chk-item">
      <div class="chk-num">${i+1}</div>
      <div class="chk-box" id="chk-${i}" onclick="toggleChk(${i})">âœ“</div>
      <div class="chk-lbl">${item}</div>
    </div>`).join('');
  document.querySelectorAll('.chk-box').forEach(b=>b.style.display='flex');
  document.querySelectorAll('.chk-box').forEach(b=>{b.style.color='transparent';});
}

function toggleChk(i){
  const el=document.getElementById('chk-'+i);
  el.classList.toggle('checked');
  el.style.color=el.classList.contains('checked')?'#fff':'transparent';
}

function renderVisitPhotoSlots(){
  const wrap=document.getElementById('vm-photos-wrap');
  let html=visitPhotos.map((p,i)=>`<img src="${p}" class="photo-thumb" onclick="viewPhoto('${encodeURIComponent(p)}','Site Photo ${i+1}')">`).join('');
  html+=`<div class="photo-slot" onclick="openCameraFor('visit-photo')"><span>ğŸ“·</span><span>Add</span></div>`;
  wrap.innerHTML=html;
}

function addVisitPhoto(data){visitPhotos.push(data);renderVisitPhotoSlots();}

function saveVisit(){
  const engId=document.getElementById('vm-eng').value;
  if(!engId){alert('Please select engineer/overseer');return;}
  const checklist=CHECKLIST_ITEMS.map((_,i)=>document.getElementById('chk-'+i).classList.contains('checked'));
  const score=checklist.filter(Boolean).length;
  const rec={
    id:Date.now(),
    workId:document.getElementById('vm-wid').value.trim(),
    village:document.getElementById('vm-vil').value.trim(),
    block:document.getElementById('vm-block').value,
    engineerId:engId,
    date:document.getElementById('vm-date').value,
    checklist,score,
    notes:document.getElementById('vm-notes').value.trim(),
    photos:visitPhotos.slice()
  };
  APP.visits.push(rec);
  const eng=APP.staff.find(s=>s.id==engId);
  audit('ğŸ”','Site Visit Logged',`${eng?eng.name:'Staff'} Â· ${rec.village||rec.workId} Â· Score: ${score}/10`);
  save();closeModal('visit-modal');renderVisits();
}

function deleteVisit(id){
  if(!confirm('Delete this visit record?'))return;
  APP.visits=APP.visits.filter(v=>v.id!==id);save();renderVisits();
}

function renderVisits(){
  const sg=document.getElementById('visit-summary');
  const vs=document.getElementById('visit-list');
  const avgScore=APP.visits.length?Math.round(APP.visits.reduce((a,v)=>a+v.score,0)/APP.visits.length):0;
  sg.innerHTML=`
    <div class="sc cn"><div class="si">ğŸ”</div><div class="sv">${APP.visits.length}</div><div class="sl">Total Visits</div></div>
    <div class="sc cg"><div class="si">â­</div><div class="sv">${avgScore}/10</div><div class="sl">Avg Quality Score</div></div>
    <div class="sc cb"><div class="si">ğŸ“·</div><div class="sv">${APP.visits.reduce((a,v)=>a+v.photos.length,0)}</div><div class="sl">Photos Captured</div></div>
  `;
  const srch=(document.getElementById('visit-search').value||'').toLowerCase();
  let filtered=APP.visits.filter(v=>!srch||`${v.workId} ${v.village} ${APP.staff.find(s=>s.id==v.engineerId)?.name||''}`.toLowerCase().includes(srch)).sort((a,b)=>b.id-a.id);
  if(!filtered.length){vs.innerHTML='<div class="empty"><div class="ei">ğŸ”</div><h3>No visit records</h3><p>Log a site visit to track quality inspections.</p></div>';return;}
  vs.innerHTML=filtered.map(v=>{
    const eng=APP.staff.find(s=>s.id==v.engineerId);
    const scorePct=Math.round(v.score*100/10);
    const sColor=v.score>=8?'var(--green-light)':v.score>=5?'var(--saffron)':'var(--red-light)';
    return`<div class="card" style="margin-bottom:10px">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px">
        <div>
          <div style="font-weight:700;font-size:14px">${v.village||v.workId||'General Inspection'}</div>
          <div style="font-size:11px;color:var(--txm)">ğŸ“… ${v.date} Â· ${v.block} ${v.workId?'Â· WID: '+v.workId:''}</div>
          <div style="font-size:12px;margin-top:3px">ğŸ‘· ${eng?eng.name:'Unknown'} <span class="desig-badge ${eng?DESIG_CLS[eng.desig]:'dSI'}" style="margin-left:4px">${eng?DESIG_MAP[eng.desig]:'â€”'}</span></div>
        </div>
        <div style="text-align:center">
          <div style="font-size:22px;font-weight:700;color:${sColor};font-family:DM Mono,monospace">${v.score}/10</div>
          <div style="font-size:10px;color:var(--txm)">Quality Score</div>
          <button class="btn btn-d btn-sm" style="margin-top:6px" onclick="deleteVisit(${v.id})">ğŸ—‘</button>
        </div>
      </div>
      <div class="pb" style="height:8px"><div class="pf ${scorePct>=80?'pg':scorePct>=50?'po':'pr'}" style="width:${scorePct}%"></div></div>
      <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:8px">
        ${CHECKLIST_ITEMS.map((item,i)=>`<span style="font-size:10px;padding:2px 6px;border-radius:10px;background:${v.checklist[i]?'rgba(34,168,106,.15)':'rgba(220,38,38,.1)'};color:${v.checklist[i]?'#22a86a':'#f87171'}">${i+1}. ${item.split('(')[0].trim()}</span>`).join('')}
      </div>
      ${v.notes?`<div style="font-size:12px;color:var(--txm);margin-top:8px;padding-top:8px;border-top:1px solid var(--bor)">ğŸ“ ${v.notes}</div>`:''}
      ${v.photos&&v.photos.length?`<div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">${v.photos.map((p,i)=>`<img src="${p}" class="photo-thumb" onclick="viewPhoto('${encodeURIComponent(p)}','Site Photo ${i+1}')">`).join('')}</div>`:''}
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANALYTICS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAnalytics(){
  const el=document.getElementById('risk-table');
  const as=document.getElementById('ana-summary');
  if(!APP.currentData.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“ˆ</div><h3>No data loaded</h3></div>';as.innerHTML='';return;}
  const s=stats(APP.currentData);
  // Stagnant map
  const stagnantVil={};
  if(APP.snapshots.length>=2){
    const first=APP.snapshots[0],last=APP.snapshots[APP.snapshots.length-1];
    const firstMap={};first.data.forEach(d=>firstMap[d.workId]=d.stage);
    last.data.filter(d=>!done(d.stage)&&firstMap[d.workId]===d.stage).forEach(d=>{stagnantVil[d.village]=(stagnantVil[d.village]||0)+1;});
  }
  // Risk scores
  const villages=Object.entries(s.byVil).map(([v,vd])=>({name:v,block:vd.block,...vd,risk:riskScore(vd,stagnantVil[v]||0)}));
  const highRisk=villages.filter(v=>v.risk>60).length;
  const medRisk=villages.filter(v=>v.risk>30&&v.risk<=60).length;
  const lowRisk=villages.filter(v=>v.risk<=30).length;
  as.innerHTML=`
    <div class="sc cn"><div class="si">ğŸ˜</div><div class="sv">${villages.length}</div><div class="sl">Villages Tracked</div></div>
    <div class="sc cg"><div class="si">âœ…</div><div class="sv">${lowRisk}</div><div class="sl">Low Risk Villages</div></div>
    <div class="sc cs"><div class="si">âš ï¸</div><div class="sv">${medRisk}</div><div class="sl">Medium Risk</div></div>
    <div class="sc cr"><div class="si">ğŸ”´</div><div class="sv">${highRisk}</div><div class="sl">High Risk Villages</div></div>
  `;
  // Trend chart
  renderTrend();
  // Prediction
  renderPrediction(s);
  // Village risk table
  const srch=(document.getElementById('ana-search').value||'').toLowerCase();
  const sorted=villages.filter(v=>!srch||v.name.toLowerCase().includes(srch)).sort((a,b)=>b.risk-a.risk);
  el.innerHTML=`<div class="tw"><table class="dt">
    <thead><tr><th>#</th><th>Village</th><th>Block</th><th>Total</th><th>Done</th><th>%</th><th>Stagnant</th><th>Risk Score</th><th>Progress</th></tr></thead>
    <tbody>${sorted.map((v,i)=>`<tr>
      <td style="color:var(--txm);font-size:11px">${i+1}</td>
      <td style="font-weight:600">${v.name}</td>
      <td><span style="background:var(--navy);color:#fff;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:700">${v.block}</span></td>
      <td>${v.total}</td>
      <td style="color:var(--green-light);font-weight:600">${v.completed}</td>
      <td style="font-weight:700;color:${v.pct===100?'var(--green-light)':v.pct>=80?'var(--teal-light)':v.pct>=50?'var(--saffron)':'var(--red-light)'}">${Math.round(v.completed*100/v.total)}%</td>
      <td>${stagnantVil[v.name]||0}</td>
      <td><span class="${riskCls(v.risk)}">${v.risk}</span></td>
      <td style="min-width:80px"><div class="pb" style="height:7px"><div class="pf ${v.pct>80?'pg':v.pct>50?'po':'pr'}" style="width:${Math.round(v.completed*100/v.total)}%"></div></div></td>
    </tr>`).join('')}
    </tbody></table></div>`;
}

function renderTrend(){
  const el=document.getElementById('trend-chart');
  if(APP.snapshots.length<2){el.innerHTML='<div style="color:var(--txm);font-size:12px;padding:20px 0;text-align:center">Upload 2+ snapshots to see trend</div>';return;}
  const W=400,H=120,PL=40,PT=10,PR=20,PB=30;
  const pts=APP.snapshots.map(s=>({date:new Date(s.date),pct:stats(s.data).pct}));
  const minD=pts[0].date.getTime(),maxD=pts[pts.length-1].date.getTime();
  const dR=maxD-minD||1;
  const xOf=d=>PL+(d.getTime()-minD)/dR*(W-PL-PR);
  const yOf=p=>PT+H-(p/100*(H-PB));
  const pathD=pts.map((p,i)=>`${i?'L':'M'}${xOf(p.date)},${yOf(p.pct)}`).join(' ');
  const areaD=pathD+` L${xOf(pts[pts.length-1].date)},${PT+H} L${xOf(pts[0].date)},${PT+H} Z`;
  const circles=pts.map(p=>`<circle cx="${xOf(p.date)}" cy="${yOf(p.pct)}" r="4" fill="var(--gold)" stroke="var(--bgc)" stroke-width="2"><title>${p.date.toLocaleDateString('en-IN')}: ${p.pct}%</title></circle>`).join('');
  const labels=pts.map(p=>`<text x="${xOf(p.date)}" y="${yOf(p.pct)-10}" text-anchor="middle" font-size="9" fill="var(--txm)">${p.pct}%</text>`).join('');
  el.innerHTML=`<svg viewBox="0 0 ${W} ${PT+H+10}" class="trend-svg">
    <defs><linearGradient id="tg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--gold)" stop-opacity=".3"/><stop offset="100%" stop-color="var(--gold)" stop-opacity=".02"/></linearGradient></defs>
    <path d="${areaD}" fill="url(#tg)"/>
    <path d="${pathD}" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linejoin="round"/>
    ${circles}${labels}
    <text x="${PL-4}" y="${yOf(100)}" text-anchor="end" font-size="8" fill="var(--txm)">100%</text>
    <text x="${PL-4}" y="${yOf(50)}" text-anchor="end" font-size="8" fill="var(--txm)">50%</text>
    <text x="${PL-4}" y="${yOf(0)}" text-anchor="end" font-size="8" fill="var(--txm)">0%</text>
    <line x1="${PL}" y1="${PT}" x2="${PL}" y2="${PT+H}" stroke="var(--bor)" stroke-width="1"/>
    <line x1="${PL}" y1="${PT+H-PB}" x2="${W-PR}" y2="${PT+H-PB}" stroke="var(--bor)" stroke-width="1" stroke-dasharray="3"/>
  </svg>`;
}

function renderPrediction(s){
  const el=document.getElementById('pred-content');
  if(APP.snapshots.length<2){el.innerHTML='<div style="color:var(--txm);font-size:12px">Need 2+ snapshots for predictions</div>';return;}
  const first=APP.snapshots[0],last=APP.snapshots[APP.snapshots.length-1];
  const daysDiff=(new Date(last.date)-new Date(first.date))/86400000;
  const pctDiff=stats(last.data).pct-stats(first.data).pct;
  const ratePerDay=daysDiff>0?pctDiff/daysDiff:0;
  const remaining=100-s.pct;
  let html='';
  if(ratePerDay<=0){
    html=`<div class="alert al-w"><span>âš ï¸</span><div>No measurable progress rate. Check for stagnant data.</div></div>`;
  }else{
    const daysToComplete=Math.ceil(remaining/ratePerDay);
    const predDate=new Date();predDate.setDate(predDate.getDate()+daysToComplete);
    const urgency=daysToComplete>365?'ğŸ”´':daysToComplete>180?'ğŸŸ¡':'ğŸŸ¢';
    html=`
      <div style="display:flex;flex-direction:column;gap:10px">
        <div><div style="font-size:11px;color:var(--txm)">Progress Rate</div><div style="font-size:18px;font-weight:700;color:var(--sv)">${ratePerDay.toFixed(2)}%/day</div></div>
        <div><div style="font-size:11px;color:var(--txm)">Days to Completion</div><div style="font-size:18px;font-weight:700;color:var(--sv)">${urgency} ${daysToComplete}</div></div>
        <div><div style="font-size:11px;color:var(--txm)">Predicted Date</div><div style="font-size:18px;font-weight:700;color:var(--sv)">${predDate.toLocaleDateString('en-IN',{dateStyle:'long'})}</div></div>
        <div style="font-size:11px;color:var(--txm);padding:8px;border:1px solid var(--bor);border-radius:var(--rsm)">Based on ${daysDiff.toFixed(0)} days of tracking Â· +${pctDiff.toFixed(1)}% change</div>
      </div>`;
  }
  el.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BLOCKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderBlocks(){
  const el=document.getElementById('blocks-content');
  if(!APP.currentData.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ˜</div><h3>No data loaded</h3></div>';return;}
  const s=stats(APP.currentData);
  let html=`<div class="tw"><table class="dt"><thead><tr><th>Block</th><th>Total</th><th>âœ… Done</th><th>â³ Pending</th><th>%</th><th>Roof Laid</th><th>Plastering</th><th>Spent (â‚¹L)</th><th>Progress</th></tr></thead><tbody>`;
  Object.entries(s.byBlock).sort((a,b)=>b[1].total-a[1].total).forEach(([bl,b])=>{
    const pct=Math.round(b.completed*100/b.total);
    const roof=b.stages['Roof Laid']||0;const plaster=(b.stages['Plastering']||0)+(b.stages['Whitewash / Colourwash Progress']||0);
    const spent=APP.currentData.filter(d=>d.block===bl).reduce((a,c)=>a+c.amountSpent,0);
    html+=`<tr><td style="font-weight:700">${bl}</td><td style="font-family:DM Mono,monospace">${b.total}</td><td style="color:var(--green-light);font-weight:600">${b.completed}</td><td style="color:var(--saffron)">${b.total-b.completed}</td><td style="font-weight:700;color:${pct>80?'var(--green-light)':pct>50?'var(--saffron)':'var(--red-light)'}">${pct}%</td><td>${roof}</td><td>${plaster}</td><td style="font-family:DM Mono,monospace;font-size:11px">${(spent/1e5).toFixed(1)}</td><td style="min-width:90px"><div class="pb" style="height:7px"><div class="pf ${pct>80?'pg':pct>50?'po':'pr'}" style="width:${pct}%"></div></div></td></tr>`;
  });
  html+='</tbody></table></div>';
  const vByBlock={};APP.currentData.forEach(d=>{if(!vByBlock[d.block])vByBlock[d.block]=new Set();vByBlock[d.block].add(d.village);});
  html+='<div style="margin-top:20px"><div class="sec">Block Details</div><div class="g3">';
  Object.entries(vByBlock).forEach(([bl,vset])=>{
    const b=s.byBlock[bl];const pct=Math.round(b.completed*100/b.total);
    const tc=pct>80?'var(--green-light)':pct>50?'var(--saffron)':'var(--red-light)';
    html+=`<div class="card"><div style="font-weight:700;font-size:14px">${bl}</div><div style="font-size:11px;color:var(--txm);margin:4px 0 10px">${vset.size} villages Â· ${b.total} houses</div><div class="stkbar">${stk(b.stages,b.total)}</div><div class="pb" style="height:8px;margin-top:8px"><div class="pf ${pct>80?'pg':pct>50?'po':'pr'}" style="width:${pct}%"></div></div><div style="font-size:14px;font-weight:700;color:${tc};margin-top:5px">${pct}% complete</div></div>`;
  });
  html+='</div></div>';
  el.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VILLAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderVillages(){
  const el=document.getElementById('villages-content');
  if(!APP.currentData.length){el.innerHTML='<div class="empty"><div class="ei">ğŸŒ¾</div><h3>No data loaded</h3></div>';return;}
  const s=stats(APP.currentData);
  const bf=document.getElementById('vil-blk').value,srt=document.getElementById('vil-sort').value;
  const srch=(document.getElementById('vil-srch').value||'').toLowerCase();
  let vils=Object.entries(s.byVil).filter(([v,vd])=>(!bf||vd.block===bf)&&(!srch||v.toLowerCase().includes(srch)));
  vils.sort((a,b)=>{const [av,ad]= a,[bv,bd]=b;const ap=ad.total?ad.completed/ad.total:0,bp=bd.total?bd.completed/bd.total:0;if(srt==='pct-asc')return ap-bp;if(srt==='pct-desc')return bp-ap;if(srt==='name')return av.localeCompare(bv);return bd.total-ad.total;});
  el.innerHTML=`<div style="font-size:12px;color:var(--txm);margin-bottom:10px">${vils.length} villages</div>
  <div class="tw"><table class="dt"><thead><tr><th>#</th><th>Village</th><th>Block</th><th>Total</th><th>Done</th><th>Pending</th><th>%</th><th>Stages</th></tr></thead><tbody>
  ${vils.map(([v,vd],i)=>{
    const pct=Math.round(vd.completed*100/vd.total);
    const tc=pct===100?'var(--green-light)':pct>=80?'var(--teal-light)':pct>=50?'var(--saffron)':'var(--red-light)';
    return`<tr><td style="color:var(--txm);font-size:11px">${i+1}</td><td style="font-weight:600">${v}</td><td><span style="background:var(--navy);color:#fff;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:700">${vd.block}</span></td><td>${vd.total}</td><td style="color:var(--green-light);font-weight:600">${vd.completed}</td><td style="color:var(--saffron)">${vd.total-vd.completed}</td><td><div style="display:flex;align-items:center;gap:5px"><div class="pb" style="width:55px;height:6px"><div class="pf ${pct>80?'pg':pct>50?'po':'pr'}" style="width:${pct}%"></div></div><strong style="color:${tc};font-size:11px">${pct}%</strong></div></td><td><div class="stkbar" style="min-width:70px;height:14px">${stk(vd.stages,vd.total)}</div></td></tr>`;
  }).join('')}</tbody></table></div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOUSES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const HP=100;
function renderHouses(){
  const el=document.getElementById('houses-content');
  if(!APP.currentData.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ </div><h3>No data loaded</h3></div>';return;}
  const bf=document.getElementById('h-blk').value,sf=document.getElementById('h-stg').value;
  const srch=(document.getElementById('h-srch').value||'').toLowerCase();
  const filtered=APP.currentData.filter(d=>(!bf||d.block===bf)&&(!sf||d.stage===sf)&&(!srch||`${d.workId} ${d.workName} ${d.village}`.toLowerCase().includes(srch)));
  document.getElementById('houses-count').textContent=`Showing ${Math.min(filtered.length,HP)} of ${filtered.length}`;
  el.innerHTML=`<div class="tw"><table class="dt"><thead><tr><th>#</th><th>Work ID</th><th>Block</th><th>Village</th><th>Beneficiary</th><th>Stage</th><th>Material</th><th>Amount</th></tr></thead><tbody>
  ${filtered.slice(0,HP).map((d,i)=>{
    const mats=APP.materials.filter(m=>m.workId===d.workId);
    const totC=mats.reduce((a,m)=>a+m.cemQty,0),totS=mats.reduce((a,m)=>a+m.steelQty,0);
    const matPct=mats.length?Math.round(((totC/CEM_STD)+(totS/STEEL_STD))/2*100):null;
    return`<tr><td style="color:var(--txm);font-size:11px">${i+1}</td><td style="font-family:DM Mono,monospace;font-size:11px">${d.workId}</td><td style="font-size:10px;font-weight:600">${d.block}</td><td>${d.village}</td><td style="font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${shortName(d.workName)}">${shortName(d.workName)}</td><td><span class="sbadge ${scls(d.stage)}">${d.stage}</span></td><td style="font-size:11px">${matPct!==null?`<span style="color:${matPct>=80?'var(--green-light)':matPct>=50?'var(--saffron)':'var(--red-light)'};font-weight:600">${matPct}%</span>`:'â€”'}</td><td style="font-family:DM Mono,monospace;font-size:11px">â‚¹${fmt(d.amountSpent)}</td></tr>`;
  }).join('')}
  </tbody></table></div>
  ${filtered.length>HP?`<div style="font-size:12px;color:var(--txm);text-align:center;margin-top:8px">Showing first ${HP}. Use filters to narrow.</div>`:''}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAGNANT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderStagnant(){
  const el=document.getElementById('stagnant-content');
  if(APP.snapshots.length<2){el.innerHTML=`<div class="alert al-i"><span>â„¹ï¸</span><div>Need at least <strong>2 snapshots</strong>. You have ${APP.snapshots.length}.</div></div><div class="empty"><div class="ei">ğŸ“Š</div><h3>Upload more snapshots</h3><p>Upload on different dates to detect houses with no progress.</p><br><button class="btn btn-p" onclick="P('upload')">â†’ Upload</button></div>`;return;}
  const first=APP.snapshots[0],last=APP.snapshots[APP.snapshots.length-1];
  const daysDiff=Math.round((new Date(last.date)-new Date(first.date))/86400000);
  const firstMap={};first.data.forEach(d=>firstMap[d.workId]=d.stage);
  const stagnant=last.data.filter(d=>!done(d.stage)&&firstMap[d.workId]===d.stage);
  const progressed=last.data.filter(d=>firstMap[d.workId]&&firstMap[d.workId]!==d.stage).length;
  let html=`<div class="sgrid" style="margin-bottom:14px">
    <div class="sc cr"><div class="si">ğŸ”´</div><div class="sv">${stagnant.length}</div><div class="sl">Stagnant Houses</div><div class="sp bad">No change in ${daysDiff}d</div></div>
    <div class="sc cg"><div class="si">ğŸ“ˆ</div><div class="sv">${progressed}</div><div class="sl">Progressed</div></div>
    <div class="sc cn"><div class="si">ğŸ“…</div><div class="sv">${daysDiff}</div><div class="sl">Days Between Snaps</div></div>
  </div>`;
  if(!stagnant.length){html+='<div class="alert al-s"><span>âœ…</span><div>No stagnant houses found!</div></div>';el.innerHTML=html;return;}
  const byBlock=grpBy(stagnant,'block');
  html+=`<div class="g2" style="margin-bottom:14px">
    <div class="card"><div class="card-hd">Stagnant by Block</div><div class="bc">${Object.entries(byBlock).sort((a,b)=>b[1]-a[1]).map(([b,c])=>bcBar(b,c,stagnant.length,'var(--red)',c)).join('')}</div></div>
    <div class="card"><div class="card-hd">Stagnant by Stage</div><div class="bc">${Object.entries(grpBy(stagnant,'stage')).sort((a,b)=>b[1]-a[1]).map(([st,c])=>bcBar((SC[st]||{lbl:st}).lbl,c,stagnant.length,scol(st),c)).join('')}</div></div>
  </div>
  <div class="sec" style="margin-top:16px">Stagnant Houses List</div>
  <div class="tw"><table class="dt"><thead><tr><th>#</th><th>Work ID</th><th>Block</th><th>Village</th><th>Stage</th><th>Beneficiary</th></tr></thead>
  <tbody>${stagnant.slice(0,200).map((d,i)=>`<tr><td style="color:var(--txm);font-size:11px">${i+1}</td><td style="font-family:DM Mono,monospace;font-size:11px">${d.workId}</td><td style="font-size:10px;font-weight:600">${d.block}</td><td>${d.village}</td><td><span class="sbadge ${scls(d.stage)}">${d.stage}</span></td><td style="font-size:11px">${shortName(d.workName)}</td></tr>`).join('')}</tbody></table></div>
  ${stagnant.length>200?`<div style="font-size:12px;color:var(--txm);text-align:center;margin-top:8px">Showing first 200 of ${stagnant.length}</div>`:''}`;
  el.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PENDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPending(){
  const el=document.getElementById('pending-content');
  if(!APP.currentData.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ”´</div><h3>No data loaded</h3></div>';return;}
  const firstDate=APP.snapshots.length?new Date(APP.snapshots[0].date):new Date();
  const daysSince=Math.round((new Date()-firstDate)/86400000);
  const pending=APP.currentData.filter(d=>!done(d.stage));
  let html=`<div class="sgrid" style="margin-bottom:14px">
    <div class="sc cr"><div class="si">â³</div><div class="sv">${pending.length}</div><div class="sl">${daysSince>=180?'Long Pending':'Pending'}</div></div>
    <div class="sc cn"><div class="si">ğŸ“…</div><div class="sv">${daysSince}</div><div class="sl">Days Tracked</div>${daysSince<180?`<div class="sp warn">${180-daysSince}d to 180-day mark</div>`:'<div class="sp bad">âš ï¸ Exceeded 180 days</div>'}</div>
  </div>`;
  if(!pending.length){html+='<div class="alert al-s"><span>âœ…</span><div>No pending houses!</div></div>';el.innerHTML=html;return;}
  const byBlock=grpBy(pending,'block');
  html+=`<div class="g2" style="margin-bottom:14px">
    <div class="card"><div class="card-hd">Pending by Block</div><div class="bc">${Object.entries(byBlock).sort((a,b)=>b[1]-a[1]).map(([b,c])=>bcBar(b,c,pending.length,'var(--saffron)',c)).join('')}</div></div>
    <div class="card"><div class="card-hd">Pending by Stage</div><div class="bc">${Object.entries(grpBy(pending,'stage')).sort((a,b)=>b[1]-a[1]).map(([st,c])=>bcBar((SC[st]||{lbl:st}).lbl,c,pending.length,scol(st),c)).join('')}</div></div>
  </div>
  <div class="tw"><table class="dt"><thead><tr><th>#</th><th>Work ID</th><th>Block</th><th>Village</th><th>Stage</th><th>Spent</th><th>Beneficiary</th></tr></thead>
  <tbody>${pending.slice(0,300).map((d,i)=>`<tr><td style="color:var(--txm);font-size:11px">${i+1}</td><td style="font-family:DM Mono,monospace;font-size:11px">${d.workId}</td><td style="font-size:10px;font-weight:600">${d.block}</td><td>${d.village}</td><td><span class="sbadge ${scls(d.stage)}">${d.stage}</span></td><td style="font-family:DM Mono,monospace;font-size:11px">â‚¹${fmt(d.amountSpent)}</td><td style="font-size:11px">${shortName(d.workName)}</td></tr>`).join('')}</tbody></table></div>
  ${pending.length>300?`<div style="font-size:12px;color:var(--txm);text-align:center;margin-top:8px">Showing first 300 of ${pending.length}</div>`:''}`;
  el.innerHTML=html;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPORTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderReports(){
  const el=document.getElementById('report-summary');
  if(!APP.currentData.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ“‹</div><h3>No data loaded</h3></div>';return;}
  const s=stats(APP.currentData);
  el.innerHTML=`<div class="tw"><table class="dt"><thead><tr><th>Block</th><th>Total</th><th>Completed</th><th>Pending</th><th>%</th><th>Roof Laid</th><th>Plastering</th><th>Sanctioned (â‚¹Cr)</th><th>Spent (â‚¹Cr)</th></tr></thead><tbody>
  ${Object.entries(s.byBlock).map(([bl,b])=>{
    const pct=Math.round(b.completed*100/b.total);
    const spent=APP.currentData.filter(d=>d.block===bl).reduce((a,c)=>a+c.amountSpent,0);
    const sanc=b.total*HOUSE_COST;
    return`<tr><td style="font-weight:700">${bl}</td><td>${b.total}</td><td style="color:var(--green-light);font-weight:600">${b.completed}</td><td>${b.total-b.completed}</td><td style="font-weight:700;color:${pct>80?'var(--green-light)':pct>50?'var(--saffron)':'var(--red-light)'}">${pct}%</td><td>${b.stages['Roof Laid']||0}</td><td>${(b.stages['Plastering']||0)+(b.stages['Whitewash / Colourwash Progress']||0)}</td><td style="font-family:DM Mono,monospace">${(sanc/1e7).toFixed(2)}</td><td style="font-family:DM Mono,monospace">${(spent/1e7).toFixed(2)}</td></tr>`;
  }).join('')}
  <tr style="font-weight:700;background:var(--bgh)"><td>TOTAL</td><td>${s.total}</td><td>${s.completed}</td><td>${s.pending}</td><td>${s.pct}%</td><td>${s.byStage['Roof Laid']||0}</td><td>${(s.byStage['Plastering']||0)+(s.byStage['Whitewash / Colourwash Progress']||0)}</td><td style="font-family:DM Mono,monospace">${(s.total*HOUSE_COST/1e7).toFixed(2)}</td><td style="font-family:DM Mono,monospace">${(s.totalAmt/1e7).toFixed(2)}</td></tr>
  </tbody></table></div>`;
}

function exportHousesCSV(){
  if(!APP.currentData.length){alert('No data');return;}
  const rows=[['Work ID','Block','Village','Beneficiary','Stage','Amount Spent'],...APP.currentData.map(d=>[d.workId,d.block,d.village,`"${shortName(d.workName)}"`,d.stage,d.amountSpent])];
  csvDownload(rows,`kki_houses_${new Date().toLocaleDateString('en-IN').replace(/\//g,'-')}.csv`);
  audit('ğŸ“„','Houses CSV Exported',`${APP.currentData.length} records`);
}

function exportMaterialsCSV(){
  if(!APP.materials.length){alert('No material records');return;}
  const rows=[['Date','Work ID','Block','Village','Beneficiary','Issue Type','Cement (bags)','Steel (kg)','Sand','Acknowledged','Notes'],...APP.materials.map(m=>[m.date,m.workId,m.block,m.village,`"${m.beneficiary}"`,m.issueType,m.cemQty,m.steelQty,m.sandQty,m.acknowledged?'Yes':'No',`"${m.notes||''}"`])];
  csvDownload(rows,`kki_materials_${new Date().toLocaleDateString('en-IN').replace(/\//g,'-')}.csv`);
}

function exportMaterials(){exportMaterialsCSV();}

function exportVisitsCSV(){
  if(!APP.visits.length){alert('No visit records');return;}
  const rows=[['Date','Work ID','Block','Village','Engineer','Score /10','Notes'],...APP.visits.map(v=>{const eng=APP.staff.find(s=>s.id==v.engineerId);return[v.date,v.workId,v.block,v.village,eng?eng.name:'',v.score,`"${v.notes||''}"`];})];
  csvDownload(rows,`kki_visits_${new Date().toLocaleDateString('en-IN').replace(/\//g,'-')}.csv`);
}

function exportVisits(){exportVisitsCSV();}

function exportStaffReport(){
  if(!APP.staff.length){alert('No staff added');return;}
  const rows=[['Name','Designation','Employee ID','Phone','Blocks','Villages','Total Houses','Completed','Completion %'],...APP.staff.map(s=>{const st=staffStats(s);return[s.name,DESIG_MAP[s.desig]||s.desig,s.empid||'',s.phone||'',(s.blocks||[]).join(';'),s.villages||'',st.total,st.completed,st.pct];})];
  csvDownload(rows,`kki_staff_${new Date().toLocaleDateString('en-IN').replace(/\//g,'-')}.csv`);
}

function printSummaryReport(){
  if(!APP.currentData.length){alert('No data loaded');return;}
  const s=stats(APP.currentData);
  const win=window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>KKI Progress Report</title><style>body{font-family:Arial,sans-serif;padding:30px;color:#000}h1{font-size:18px;margin-bottom:4px}h2{font-size:13px;color:#666;margin-bottom:20px}table{width:100%;border-collapse:collapse;margin:16px 0}th,td{border:1px solid #ccc;padding:8px 10px;text-align:left;font-size:12px}th{background:#0d1b3e;color:#fff}.footer{font-size:11px;color:#888;margin-top:20px;text-align:center}</style></head><body>
  <h1>Kalaignarin Kanavu Illam â€“ Progress Report</h1>
  <h2>Mayiladuthurai District Â· Generated: ${new Date().toLocaleDateString('en-IN',{dateStyle:'long'})}</h2>
  <table><tr><th>Total Houses</th><th>Completed</th><th>Pending</th><th>Completion %</th><th>Amount Spent</th></tr>
  <tr><td>${s.total}</td><td>${s.completed}</td><td>${s.pending}</td><td>${s.pct}%</td><td>â‚¹${(s.totalAmt/1e7).toFixed(2)} Cr</td></tr></table>
  <h2>Block-wise Summary</h2>
  <table><tr><th>Block</th><th>Total</th><th>Completed</th><th>Pending</th><th>%</th></tr>
  ${Object.entries(s.byBlock).map(([bl,b])=>`<tr><td>${bl}</td><td>${b.total}</td><td>${b.completed}</td><td>${b.total-b.completed}</td><td>${Math.round(b.completed*100/b.total)}%</td></tr>`).join('')}
  </table>
  <div class="footer">KKI Housing Monitor v3.0 Â· Offline Report</div>
  </body></html>`);
  win.document.close();win.print();
  audit('ğŸ–¨ï¸','Summary Report Printed','');
}

function generateCert(){
  const wid=document.getElementById('cert-wid').value.trim();
  if(!wid){alert('Enter a Work ID');return;}
  const house=APP.currentData.find(h=>h.workId===wid);
  if(!house){alert('Work ID not found in loaded data');return;}
  const mats=APP.materials.filter(m=>m.workId===wid);
  const certHtml=`<div class="cert">
    <div class="cert-seal">ğŸ…</div>
    <div class="cert-title">Completion Certificate</div>
    <div class="cert-sub">Kalaignarin Kanavu Illam Housing Scheme Â· Mayiladuthurai District</div>
    <div class="cert-field"><label>Work ID</label><span>${house.workId}</span></div>
    <div class="cert-field"><label>Beneficiary</label><span>${shortName(house.workName)}</span></div>
    <div class="cert-field"><label>Village / Block</label><span>${house.village} Â· ${house.block}</span></div>
    <div class="cert-field"><label>Current Stage</label><span>${house.stage}</span></div>
    <div class="cert-field"><label>Amount Sanctioned</label><span>â‚¹${fmt(HOUSE_COST)}</span></div>
    <div class="cert-field"><label>Amount Spent (as per OSMS)</label><span>â‚¹${fmt(house.amountSpent)}</span></div>
    ${mats.length?`<div class="cert-field"><label>Materials Issued</label><span>Cement: ${mats.reduce((a,m)=>a+m.cemQty,0)} bags Â· Steel: ${mats.reduce((a,m)=>a+m.steelQty,0)} kg</span></div>`:''}
    <div style="margin-top:30px;display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div style="text-align:center"><div style="border-top:1px solid #000;margin-top:50px;padding-top:5px;font-size:11px">Engineer / JE Signature</div></div>
      <div style="text-align:center"><div style="border-top:1px solid #000;margin-top:50px;padding-top:5px;font-size:11px">Block Development Officer</div></div>
    </div>
    <div style="text-align:center;margin-top:20px;font-size:11px;color:#888">Generated: ${new Date().toLocaleString('en-IN',{dateStyle:'long',timeStyle:'short'})}</div>
  </div>`;
  document.getElementById('cert-content').innerHTML=certHtml;
  document.getElementById('cert-modal').classList.add('open');
  audit('ğŸ…','Completion Certificate Generated',`WID: ${wid}`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROGRESS LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addLog(){
  const date=document.getElementById('log-date').value;
  const notes=document.getElementById('log-notes').value.trim();
  if(!date||!notes){alert('Date and Notes required');return;}
  const entry={id:Date.now(),date,block:document.getElementById('log-blk').value,village:document.getElementById('log-vil').value.trim(),category:document.getElementById('log-cat').value,notes};
  APP.logs.unshift(entry);
  audit('ğŸ“','Log Entry Added',`${entry.category}: ${entry.village||entry.block||'General'}`);
  save();document.getElementById('log-notes').value='';document.getElementById('log-vil').value='';renderLog();
}

function deleteLog(id){if(!confirm('Delete?'))return;APP.logs=APP.logs.filter(l=>l.id!==id);save();renderLog();}

function renderLog(){
  const el=document.getElementById('log-list');
  const srch=(document.getElementById('log-srch').value||'').toLowerCase();
  const filtered=APP.logs.filter(l=>!srch||`${l.notes} ${l.block} ${l.village} ${l.category}`.toLowerCase().includes(srch));
  if(!filtered.length){el.innerHTML='<div class="empty" style="padding:30px"><div class="ei">ğŸ“</div><h3>No entries yet</h3></div>';return;}
  el.innerHTML=filtered.map(l=>`<div class="log-e"><button class="log-del" onclick="deleteLog(${l.id})">âœ•</button>
    <div style="display:flex;flex-wrap:wrap;gap:5px;align-items:center;margin-bottom:5px">
      <span style="font-size:11px;color:var(--txm);font-family:DM Mono,monospace">ğŸ“… ${l.date}</span>
      ${l.block?`<span style="background:var(--navy);color:#fff;padding:1px 6px;border-radius:10px;font-size:9px;font-weight:700">${l.block}</span>`:''}
      <span style="background:var(--tag);color:var(--tagc);padding:1px 7px;border-radius:10px;font-size:10px;font-weight:600">${l.category}</span>
      ${l.village?`<span style="font-size:11px;color:var(--txm)">ğŸ“ ${l.village}</span>`:''}
    </div>
    <div style="font-size:13px;color:var(--tx)">${l.notes}</div>
  </div>`).join('');
}

function exportLog(){
  if(!APP.logs.length){alert('No entries');return;}
  const rows=[['Date','Block','Village','Category','Notes'],...APP.logs.map(l=>[l.date,l.block,l.village,l.category,`"${l.notes.replace(/"/g,'""')}"`])];
  csvDownload(rows,`kki_log_${new Date().toLocaleDateString('en-IN').replace(/\//g,'-')}.csv`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIT TRAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAudit(){
  const el=document.getElementById('audit-list');
  if(!APP.audit.length){el.innerHTML='<div class="empty"><div class="ei">ğŸ”’</div><h3>No audit records yet</h3><p>All actions will appear here automatically.</p></div>';return;}
  el.innerHTML=APP.audit.map(a=>`<div class="aud-row">
    <div class="aud-icon" style="background:var(--bgh)">${a.icon}</div>
    <div style="flex:1">
      <div class="aud-action"><strong>${a.action}</strong>${a.details?` â€” ${a.details}`:''}</div>
      <div class="aud-ts">${new Date(a.ts).toLocaleString('en-IN',{dateStyle:'short',timeStyle:'medium'})}</div>
    </div>
  </div>`).join('');
}

function clearAudit(){if(!confirm('Clear all audit records?'))return;APP.audit=[];save();renderAudit();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER & FILTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateHdr(){
  const total=APP.currentData.length;
  const s=total?stats(APP.currentData):null;
  document.getElementById('hdr-total').textContent=total?`ğŸ  ${total} Â· ${s.pct}%`:'â³ Load Data';
  document.getElementById('hdr-snaps').textContent=`ğŸ“ ${APP.snapshots.length}`;
}

function populateFilters(){
  const blocks=[...new Set(APP.currentData.map(d=>d.block))].sort();
  const stages=[...new Set(APP.currentData.map(d=>d.stage))].sort();
  ['vil-blk','h-blk','mat-block-filter'].forEach(id=>{
    const el=document.getElementById(id);if(!el)return;
    el.innerHTML='<option value="">All Blocks</option>'+blocks.map(b=>`<option>${b}</option>`).join('');
  });
  const hstg=document.getElementById('h-stg');
  if(hstg)hstg.innerHTML='<option value="">All Stages</option>'+stages.map(s=>`<option>${s}</option>`).join('');
}

function populateWIDList(){
  const list=document.getElementById('wid-list');
  const listG=document.getElementById('wid-list-global');
  const html=APP.currentData.map(d=>`<option value="${d.workId}">${d.workId} â€“ ${shortName(d.workName).slice(0,30)}</option>`).join('');
  if(list)list.innerHTML=html;if(listG)listG.innerHTML=html;
}

function populateStaffDropdowns(){
  const opts=APP.staff.map(s=>`<option value="${s.id}">${s.name} (${DESIG_MAP[s.desig]||s.desig})</option>`).join('');
  ['vm-eng','mm-staff'].forEach(id=>{const el=document.getElementById(id);if(el){el.innerHTML='<option value="">â€” Select Staff â€”</option>'+opts;}});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG & DROP UPLOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const dz=document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag');if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0]);});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE BACKEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const firebaseConfig = {
  apiKey: "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXX",
  authDomain: "kki-housing-monitor.firebaseapp.com",
  projectId: "kki-housing-monitor",
  storageBucket: "kki-housing-monitor.appspot.com",
  messagingSenderId: "123456789",
  appId: "1:123456789:web:abcdef"
};


firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

// â”€â”€ Save to Cloud â”€â”€
async function saveToCloud() {
  try {
    await db.collection('appData').doc('main').set({
      snapshots: APP.snapshots.map(s => ({...s, data: s.data})),
      logs: APP.logs,
      staff: APP.staff,
      visits: APP.visits,
      audit: APP.audit,
      lastUpdated: new Date().toISOString()
    });
    console.log('âœ… Saved to cloud');
  } catch(e) {
    console.warn('Cloud save failed, using local:', e);
  }
}

// â”€â”€ Load from Cloud â”€â”€
async function loadFromCloud() {
  try {
    const doc = await db.collection('appData').doc('main').get();
    if (doc.exists) {
      const d = doc.data();
      APP.snapshots = d.snapshots || [];
      APP.logs = d.logs || [];
      APP.staff = d.staff || [];
      APP.visits = d.visits || [];
      APP.audit = d.audit || [];
      // Materials are stored separately (they have photos)
      await loadMaterialsFromCloud();
      if (APP.snapshots.length) APP.currentData = APP.snapshots[APP.snapshots.length-1].data;
      updateHdr(); populateFilters(); populateWIDList(); populateStaffDropdowns();
      renderDash();
      showSyncBadge('âœ… Synced from cloud');
    }
  } catch(e) {
    console.warn('Cloud load failed, using local data:', e);
    load(); // fallback to localStorage
  }
}

// â”€â”€ Materials stored separately (large due to photos) â”€â”€
async function loadMaterialsFromCloud() {
  const snap = await db.collection('materials').orderBy('id').get();
  APP.materials = snap.docs.map(d => d.data());
}

// â”€â”€ Upload beneficiary photo to Storage â”€â”€
async function uploadPhotoToStorage(base64Data, workId) {
  try {
    const blob = await fetch(base64Data).then(r => r.blob());
    const ref = storage.ref(`beneficiary-photos/${workId}_${Date.now()}.jpg`);
    await ref.put(blob);
    return await ref.getDownloadURL();
  } catch(e) {
    console.warn('Photo upload failed:', e);
    return base64Data; // fall back to base64
  }
}

// â”€â”€ Save a single material record â”€â”€
async function saveMaterialToCloud(rec) {
  try {
    // Upload photo to Storage instead of storing base64
    if (rec.photo && rec.photo.startsWith('data:')) {
      rec.photoUrl = await uploadPhotoToStorage(rec.photo, rec.workId);
      rec.photo = null; // don't store large base64 in Firestore
    }
    await db.collection('materials').doc(String(rec.id)).set(rec);
  } catch(e) {
    console.warn('Material save failed:', e);
  }
}

// â”€â”€ Sync status badge â”€â”€
function showSyncBadge(msg) {
  const el = document.getElementById('hdr-snaps');
  const prev = el.textContent;
  el.textContent = msg;
  el.style.background = 'rgba(34,168,106,.3)';
  setTimeout(() => { el.textContent = prev; el.style.background = ''; }, 3000);
}

// â”€â”€ Override save() to also save to cloud â”€â”€
const _localSave = save;
save = function() {
  _localSave(); // keep localStorage as backup
  saveToCloud(); // push to cloud
  showSyncBadge('â˜ï¸ Saving...');
};

// â”€â”€ Override saveMaterial() to upload photo â”€â”€
const _origSaveMat = saveMaterial;
saveMaterial = async function() {
  _origSaveMat(); // saves locally first
  // push the latest material to cloud
  const latest = APP.materials[APP.materials.length - 1];
  if (latest) await saveMaterialToCloud({...latest});
};

// â”€â”€ Listen for real-time changes from other users â”€â”€
db.collection('appData').doc('main').onSnapshot(doc => {
  if (doc.exists && doc.metadata.hasPendingWrites === false) {
    // Data changed by another user â€” reload
    const d = doc.data();
    APP.snapshots = d.snapshots || APP.snapshots;
    APP.logs = d.logs || APP.logs;
    APP.staff = d.staff || APP.staff;
    APP.visits = d.visits || APP.visits;
    if (APP.snapshots.length) APP.currentData = APP.snapshots[APP.snapshots.length-1].data;
    updateHdr();
    showSyncBadge('ğŸ”„ Updated by another user');
  }
});

// â”€â”€ Start by loading from cloud â”€â”€
loadFromCloud();
document.getElementById('log-date').value=new Date().toISOString().split('T')[0];
load();updateHdr();
if(APP.currentData.length){populateFilters();populateWIDList();}
populateStaffDropdowns();
renderDash();renderSnaps();
</script>
</body>
</html>
